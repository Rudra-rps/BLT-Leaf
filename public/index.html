<!DOCTYPE html>
<html lang="en" class="">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PR Readiness Checker - BLT-Leaf</title>
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <link rel="preconnect" href="https://cdn.tailwindcss.com">
    <link rel="preconnect" href="https://cdnjs.cloudflare.com">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        window.tailwind = {
            config: {
                darkMode: 'class'
            }
        };

        // Initialize theme immediately to prevent FOUC
        (function () {
            const savedTheme = localStorage.getItem('theme');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            const theme = savedTheme || (prefersDark ? 'dark' : 'light');

            if (theme === 'dark') {
                document.documentElement.classList.add('dark');
            }
        })();
    </script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <style>
        html,
        body {
            height: 100%;
        }

        #mainContentArea {
            overflow: hidden;
            min-height: 0;
            height: calc(100vh - var(--workspace-top-offset, 64px));
        }

        #analysisLayout {
            display: flex;
            flex-direction: column;
            gap: 12px;
            min-height: 0;
            flex: 1;
            overflow: hidden;
            height: 100%;
        }

        #prListPane {
            min-height: 0;
            overflow: hidden;
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        #prDetailPanel {
            display: flex;
            flex-direction: column;
            background: #fff;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            min-height: 220px;
            height: 100%;
            max-height: none;
            box-shadow: inset 0 1px 0 rgba(148, 163, 184, 0.18);
        }

        .dark #prDetailPanel {
            background: rgba(30, 41, 59, 0.4);
            border-color: #334155;
        }

        .panel-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
            padding: 10px 12px;
            border-bottom: 1px solid #e2e8f0;
        }

        .dark .panel-header {
            border-bottom-color: #334155;
        }

        .panel-body {
            flex: 1;
            overflow: hidden;
            padding: 12px;
        }

        #repoSidebar {
            overflow-y: auto;
        }

        #sidebarBackdrop {
            display: none;
        }

        #mainColumn {
            overflow: visible;
            min-height: 0;
            display: flex;
            flex-direction: column;
        }

        #prListContainer {
            contain: layout style paint;
            display: flex;
            flex-direction: column;
            min-height: 0;
            flex: 1;
            height: 100%;
        }

        .pr-table-scroll {
            overflow-y: auto;
            flex: 1;
            min-height: 0;
            max-height: none;
        }

        .pr-row-select {
            cursor: pointer;
        }

        .filter-chip {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            border: 1px solid #e2e8f0;
            border-radius: 999px;
            background: #f8fafc;
            color: #64748b;
            font-size: 11px;
            font-weight: 600;
            line-height: 1;
            padding: 4px 8px;
            transition: all 0.12s ease;
            white-space: nowrap;
        }

        .dark .filter-chip {
            border-color: #334155;
            background: #1e293b;
            color: #94a3b8;
        }

        .filter-chip.active {
            border-color: #f5b0b0;
            background: #fff1f1;
            color: #bc0000;
        }

        .dark .filter-chip.active {
            border-color: #7f1d1d;
            background: rgba(127, 29, 29, 0.25);
            color: #fca5a5;
        }

        .history-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-top: 4px;
            flex-shrink: 0;
        }

        @media (min-width: 1024px) {
            #analysisLayout {
                display: grid;
                grid-template-columns: minmax(0, 1fr) 360px;
                align-items: stretch;
                min-height: 0;
            }

            #repoSidebar {
                transition: width 0.2s ease, min-width 0.2s ease, transform 0.2s ease, opacity 0.2s ease;
            }

            body.desktop-sidebar-collapsed #repoSidebar {
                width: 0 !important;
                min-width: 0 !important;
                border-right-width: 0;
                transform: translateX(-100%);
                opacity: 0;
                overflow: hidden;
                pointer-events: none;
            }

            #prDetailPanel {
                position: sticky;
                top: var(--panel-top-offset, 64px);
                align-self: start;
                border-left: 1px solid #334155;
            }

            #closePanelBtn {
                display: none;
            }
        }

        @media (max-width: 1023px) {
            #sidebarBackdrop {
                display: block;
                position: fixed;
                top: var(--sidebar-top-offset, 0px);
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(15, 23, 42, 0.6);
                opacity: 0;
                pointer-events: none;
                transition: opacity 0.2s ease;
                z-index: 35;
            }

            #repoSidebar {
                position: fixed;
                top: var(--sidebar-top-offset, 0px);
                left: 0;
                bottom: 0;
                width: min(86vw, 320px);
                border-right: 1px solid #334155;
                border-bottom: 0;
                transform: translateX(-100%);
                transition: transform 0.22s ease;
                z-index: 40;
                box-shadow: 0 16px 40px rgba(15, 23, 42, 0.35);
            }

            body.sidebar-open #repoSidebar {
                transform: translateX(0);
            }

            body.sidebar-open #sidebarBackdrop {
                opacity: 1;
                pointer-events: auto;
            }

            body.sidebar-open {
                overflow: hidden;
            }
        }

        /* Fallback visibility if CDN is blocked */
        .btn-fallback {
            background: #E10000;
            color: #fff;
            border: 1px solid #BC0000;
        }

        /* Active PR row highlighting */
        .pr-row-active {
            background-color: #ffe4e6 !important; /* light red tint */
            border-left: 3px solid #ef4444;
        }

        .dark .pr-row-active {
            background-color: rgba(220, 38, 38, 0.18) !important; /* soft red glow */
            border-left: 3px solid #ef4444;
        }

        /* Dark mode fallback styles (when Tailwind CDN fails to load) */
        .dark {
            color-scheme: dark;
        }

        /* Body and main containers */
        .dark body {
            background-color: #0f172a !important; /* slate-900 */
            color: #f1f5f9 !important; /* slate-100 */
        }

        /* Header */
        .dark header {
            background-color: #1e293b !important; /* slate-800 */
            border-color: #334155 !important; /* slate-700 */
        }

        /* Sidebar */
        .dark aside {
            background-color: #1e293b !important; /* slate-800 */
            border-color: #334155 !important; /* slate-700 */
        }

        /* Cards and main content areas */
        .dark main > div,
        .dark .bg-white {
            background-color: #1e293b !important; /* slate-800 */
        }

        /* Text colors */
        .dark h1, .dark h2, .dark h3, .dark h4, .dark h5, .dark h6 {
            color: #ffffff !important;
        }

        .dark .text-slate-900 {
            color: #f1f5f9 !important; /* slate-100 */
        }

        .dark .text-slate-700 {
            color: #cbd5e1 ; /* slate-300 */
        }

        .dark .text-slate-600 {
            color: #cbd5e1 !important; /* slate-300 */
        }

        .dark .text-slate-500 {
            color: #94a3b8 !important; /* slate-400 */
        }

        .dark .text-slate-400 {
            color: #94a3b8 !important; /* slate-400 */
        }

        /* Inputs and form elements */
        .dark input[type="text"],
        .dark input[type="search"],
        .dark input[type="email"],
        .dark input[type="number"],
        .dark input[type="url"],
        .dark textarea,
        .dark select {
            background-color: #0f172a !important; /* slate-900 */
            color: #ffffff !important;
            border-color: #e74c3c !important;
        }

        .dark input::placeholder,
        .dark textarea::placeholder {
            color: #94a3b8 !important; /* slate-400 */
        }

        .dark input:focus,
        .dark textarea:focus,
        .dark select:focus {
            border-color: #ef4444 !important; /* red-500 */
            outline: none;
        }

        /* Buttons */
        .dark button:not(.bg-red-600):not([class*="bg-red"]):not([class*="bg-slate-500"]):not([class*="bg-green"]):not([class*="bg-blue"]) {
            background-color: #475569 !important; /* slate-600 */
            color: #f1f5f9 !important;
        }

        .dark button:hover:not(.bg-red-600):not([class*="bg-red"]):not([class*="bg-slate-500"]):not([class*="bg-green"]):not([class*="bg-blue"]) {
            background-color: #334155 !important; /* slate-700 */
        }

        /* Tables */
        .dark table {
            border-color: #334155 !important; /* slate-700 */
        }

        .dark th {
            background-color: #1e293b !important; /* slate-800 */
            color: #f1f5f9 !important;
            border-color: #334155 !important;
        }

        .dark td {
            border-color: #334155 !important; /* slate-700 */
            color: #e2e8f0 !important; /* slate-200 */
        }

        .dark tr:hover {
            background-color: #334155 !important; /* slate-700 */
        }

        /* Borders */
        .dark .border,
        .dark [class*="border-"] {
            border-color: #334155 !important; /* slate-700 */
        }

        .dark .border-slate-200 {
            border-color: #334155 !important; /* slate-700 */
        }

        .dark .divide-y > * {
            border-color: #334155 !important; /* slate-700 */
        }

        /* Hover states */
        .dark .hover\:bg-slate-100:hover,
        .dark [class*="hover:bg-slate-100"]:hover {
            background-color: #334155 !important; /* slate-700 */
        }

        .dark .hover\:bg-slate-50:hover {
            background-color: #1e293b !important; /* slate-800 */
        }

        /* Status badges and alerts */
        .dark .bg-slate-50 {
            background-color: #0f172a !important; /* slate-900 */
        }

        .dark .bg-slate-100 {
            background-color: #1e293b !important; /* slate-800 */
        }

        .dark .bg-slate-200 {
            background-color: #334155 !important; /* slate-700 */
        }

        /* Special background colors for status indicators */
        .dark .bg-green-50 {
            background-color: rgba(6, 78, 59, 0.3) !important; /* emerald-950/30 */
        }

        .dark .bg-red-50 {
            background-color: rgba(69, 10, 10, 0.3) !important; /* red-950/30 */
        }

        .dark .bg-amber-50,
        .dark .bg-yellow-50 {
            background-color: rgba(69, 26, 3, 0.3) !important; /* amber-950/30 */
        }

        /* Text colors for status indicators */
        .dark .text-green-700,
        .dark .text-green-600 {
            color: #4ade80 !important; /* green-400 */
        }

        .dark .text-emerald-700,
        .dark .text-emerald-600 {
            color: #34d399 !important; /* emerald-400 */
        }

        .dark .text-red-700,
        .dark .text-red-600 {
            color: #f87171 !important; /* red-400 */
        }

        .dark .text-amber-700,
        .dark .text-amber-600,
        .dark .text-yellow-700 {
            color: #fbbf24 !important; /* amber-400 */
        }

        .dark .text-orange-700,
        .dark .text-orange-600 {
            color: #fb923c !important; /* orange-400 */
        }

        .dark .text-blue-700,
        .dark .text-blue-600 {
            color: #60a5fa !important; /* blue-400 */
        }

        /* Links */
        .dark a {
            color: #60a5fa !important; /* blue-400 */
        }

        .dark a:hover {
            color: #93c5fd !important; /* blue-300 */
        }

        /* Disabled states */
        .dark button:disabled,
        .dark input:disabled {
            background-color: #450a0a !important; /* red-950 */
            border-color: #991b1b !important; /* red-800 */
            color: #f87171 !important; /* red-400 */
            opacity: 0.6;
        }

        /* Scrollbars */
        .dark ::-webkit-scrollbar {
            background-color: #1e293b;
        }

        .dark ::-webkit-scrollbar-thumb {
            background-color: #475569;
            border-radius: 4px;
        }

        .dark ::-webkit-scrollbar-thumb:hover {
            background-color: #64748b;
        }
    </style>
</head>

<body class="flex h-screen flex-col overflow-hidden bg-slate-50 text-slate-900 antialiased dark:bg-slate-900 dark:text-slate-100">
    <header class="sticky top-0 z-30 border-b border-slate-200 bg-white px-5 dark:border-slate-700 dark:bg-slate-800">
        <div class="mx-auto flex h-14 items-center justify-between px-4 sm:px-6 lg:px-8">

            <div class="flex items-center gap-4 lg:gap-6">
                <button id="sidebarToggleBtn"
                    class="inline-flex rounded-lg p-2 text-slate-500 hover:bg-slate-100 focus:outline-none focus:ring-2 focus:ring-slate-200 dark:text-slate-400 dark:hover:bg-slate-700 dark:focus:ring-slate-600"
                    title="Toggle repositories panel"
                    aria-label="Toggle repositories panel"
                    aria-controls="repoSidebar"
                    aria-expanded="true">
                    <i class="fas fa-bars"></i>
                </button>
                <a href="/" class="flex shrink-0 items-center gap-2 hover:opacity-80 transition-opacity">
                    <img width="28" src="./static/logo.png" alt="Logo" onerror="this.style.display='none'" />
                    <h1 class="hidden font-bold text-slate-900 dark:text-white sm:block">BLT-LEAF</h1>
                </a>

                <div class="hidden items-center gap-2 sm:flex pl-4 border-l border-slate-200 dark:border-slate-700 h-8">
                    <span class="text-[10px] font-medium text-slate-500 dark:text-slate-400">API Limit:</span>
                    <div class="rate-limit-bar h-1.5 w-20 overflow-hidden rounded-full bg-slate-200 dark:bg-slate-700">
                        <div class="h-full w-0 rounded-full bg-green-500 transition-all duration-300"
                            id="rateLimitFill"></div>
                    </div>
                    <span class="text-[10px] font-semibold text-slate-500 dark:text-slate-400"
                        id="rateLimitText">N/A</span>
                    <span class="text-[10px] text-slate-400 dark:text-slate-500" id="rateLimitUsed"></span>
                    <span class="text-[10px] text-slate-400 dark:text-slate-500" id="rateLimitReset"></span>
                </div>
            </div>

            <div class="flex flex-1 items-center justify-center px-4 md:px-8 lg:px-12">
                <div class="flex w-full max-w-lg gap-2">
                    <div class="relative flex-1">
                        <div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3">
                            <i class="fas fa-search text-slate-400"></i>
                        </div>
                        <input type="text" id="prSearchInput"
                            class="block w-full rounded-md border border-[#e74c3c] bg-slate-50 py-2 pl-10 pr-3 text-sm text-slate-900 placeholder:text-slate-500 dark:border-[#e74c3c] dark:bg-slate-900 dark:text-white dark:placeholder:text-slate-400 dark:focus:border-red-500 transition-colors shadow-sm"
                            placeholder="Search PRs..." autocomplete="off">
                    </div>
                    <button id="searchBtn"
                        class="rounded-md bg-red-600 px-4 py-2 text-sm font-semibold text-white hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 transition-colors shadow-sm whitespace-nowrap">
                        <i class="fas fa-search"></i> Search
                    </button>
                    <button id="clearSearchBtn"
                        class="rounded-md bg-slate-500 px-4 py-2 text-sm font-semibold text-white hover:bg-slate-600 focus:outline-none focus:ring-2 focus:ring-slate-400 transition-colors shadow-sm whitespace-nowrap">
                        <i class="fas fa-times"></i> Clear
                    </button>
                </div>
            </div>

            <div class="flex shrink-0 items-center gap-3">
                <button id="autoRefreshToggle"
                    class="rounded-lg p-2 text-slate-500 hover:bg-slate-100 focus:outline-none focus:ring-2 focus:ring-slate-200 dark:text-slate-400 dark:hover:bg-slate-700 dark:focus:ring-slate-600 transition-colors"
                    title="Toggle auto-refresh">
                    <i class="fas fa-sync-alt" id="autoRefreshIcon"></i>
                </button>
                <button id="themeToggle"
                    class="rounded-lg p-2 text-slate-500 hover:bg-slate-100 focus:outline-none focus:ring-2 focus:ring-slate-200 dark:text-slate-400 dark:hover:bg-slate-700 dark:focus:ring-slate-600">
                    <i class="fas fa-moon" id="themeIcon"></i>
                </button>
                <a href="/how-it-works.html"
                    class="hidden md:inline-flex items-center gap-2 rounded-lg px-3 py-2 text-sm font-medium text-slate-700 hover:bg-slate-100 dark:text-slate-300 dark:hover:bg-slate-700 transition-colors">
                    <i class="fas fa-question-circle"></i>
                    <span>How It Works</span>
                </a>
                <span id="releaseVersion"
                    class="hidden text-xs text-slate-500 dark:text-slate-400 md:inline-block"></span>
                <a href="https://github.com/OWASP-BLT/BLT-Leaf" target="_blank" rel="noopener noreferrer"
                    class="hidden rounded-lg bg-red-600 px-3 py-2 text-sm font-semibold text-white hover:bg-red-700 md:inline-flex items-center gap-2 transition-colors shadow-sm">
                    <i class="fab fa-github"></i> <span>Contribute</span>
                </a>
            </div>
        </div>
    </header>

    <div id="sidebarBackdrop" aria-hidden="true"></div>

    <div id="mainContentArea" class="mx-auto flex min-h-0 w-full flex-1 flex-col md:flex-row">
        <aside id="repoSidebar"
            class="w-full border-b border-slate-200 bg-white md:w-72 md:border-b-0 md:border-r dark:border-slate-700 dark:bg-slate-800">
            <div class="p-4">
                <h2 class="mb-3 text-xs font-semibold uppercase tracking-[0.12em] text-slate-500 dark:text-slate-400">
                    Repositories <span id="repoCountDisplay"></span></h2>
                <ul id="repoList" class="space-y-2">
                    <li class="repo-item active cursor-pointer rounded-lg border border-[#f5b0b0] bg-[#fff1f1] px-3 py-2 dark:border-red-900 dark:bg-red-950/30"
                        data-repo="all">
                        <div class="repo-name text-sm font-semibold text-[#BC0000] dark:text-red-400">All Repositories
                        </div>
                        <div class="repo-count mt-0.5 text-xs text-slate-500 dark:text-slate-400" id="allReposCount">0
                            PRs</div>
                    </li>
                </ul>
            </div>
        </aside>

        <main id="mainColumn" class="min-h-0 flex-1 overflow-hidden p-3 sm:p-4">
            <section class="mb-4 space-y-2">
                <div class="flex w-full max-w-4xl flex-col gap-2 sm:flex-row">
                    <input type="text" id="prUrlInput"
                        class="w-full rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm text-slate-900 placeholder:text-slate-400 focus:border-[#E10000] focus:outline-none focus:ring-2 focus:ring-[#ffe3e3] dark:border-slate-600 dark:bg-slate-700 dark:text-slate-100 dark:placeholder:text-slate-500 dark:focus:ring-red-900/50"
                        placeholder="Enter GitHub PR URL or Repository URL" autocomplete="off" />
                    <button id="addPrBtn"
                        class="btn-fallback w-[6rem] rounded-lg px-4 py-2 text-sm font-semibold transition-colors hover:bg-[#BC0000] disabled:cursor-not-allowed disabled:border-red-300 disabled:bg-red-200 disabled:text-red-700 dark:disabled:border-red-800 dark:disabled:bg-red-950 dark:disabled:text-red-400">
                        Add PR
                    </button>
                </div>

                <div class="mt-2 flex items-center gap-2">
                    <input type="checkbox" id="addAllPrsCheckbox"
                        class="h-4 w-4 rounded border-slate-300 text-[#E10000] focus:ring-[#E10000] dark:border-slate-600 dark:bg-slate-700">
                    <label for="addAllPrsCheckbox"
                        class="text-sm text-slate-600 dark:text-slate-400 cursor-pointer select-none">
                        Add all active PRs from this repo
                    </label>
                </div>
            </section>

            <div id="analysisLayout">
                <div id="prListPane">
                    <div id="prListContainer">
                        <div
                            class="rounded-xl border border-dashed border-slate-300 bg-white p-10 text-center dark:border-slate-600 dark:bg-slate-800">
                            <h3 class="text-xl font-semibold text-slate-900 dark:text-slate-100">No PRs Added Yet</h3>
                            <p class="mt-2 text-sm text-slate-500 dark:text-slate-400">Add a GitHub PR URL above to start
                                tracking</p>
                        </div>
                    </div>
                </div>
                <aside id="prDetailPanel">
                    <div class="panel-header">
                        <div class="min-w-0">
                            <div id="panelPrTitle" class="truncate text-xs font-bold text-slate-900 dark:text-slate-100">Select a PR</div>
                            <a id="panelPrLink" href="#" target="_blank" rel="noopener noreferrer"
                                class="block truncate text-[10px] text-slate-500 hover:text-red-600 dark:text-slate-400 dark:hover:text-red-400"></a>
                        </div>
                        <button id="closePanelBtn"
                            class="rounded p-1 text-slate-500 hover:bg-slate-100 hover:text-slate-700 dark:text-slate-400 dark:hover:bg-slate-800 dark:hover:text-slate-300">
                            <i class="fas fa-times text-xs"></i>
                        </button>
                    </div>
                    <div id="panelBody" class="panel-body">
                        <p class="text-xs italic text-slate-500 dark:text-slate-400">Select a PR row to view detailed stats and refresh history.</p>
                    </div>
                </aside>
            </div>
        </main>
    </div>

    <div id="rawDataModal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm"></div>
        <div class="relative flex h-full w-full items-center justify-center p-4">
            <div class="w-full max-w-3xl rounded-xl border border-slate-200 bg-white shadow-xl dark:border-slate-700 dark:bg-slate-800">
                <div class="flex items-center justify-between border-b border-slate-200 px-4 py-3 dark:border-slate-700">
                    <div class="text-sm font-semibold text-slate-900 dark:text-slate-100">Raw PR Data</div>
                    <button id="closeRawDataModal" class="rounded p-1 text-slate-500 hover:bg-slate-100 hover:text-slate-700 dark:text-slate-400 dark:hover:bg-slate-700 dark:hover:text-slate-200" aria-label="Close raw data modal">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="px-4 py-3">
                    <pre id="rawDataContent" class="max-h-[70vh] overflow-x-auto overflow-y-auto rounded-lg border border-slate-200 bg-slate-50 p-3 text-xs text-slate-800 dark:border-slate-700 dark:bg-slate-900 dark:text-slate-200"><code class="language-json"></code></pre>
                </div>
                <div class="flex items-center justify-end gap-2 border-t border-slate-200 px-4 py-3 dark:border-slate-700">
                    <button id="copyRawDataBtn" class="rounded border border-slate-300 bg-white px-3 py-1.5 text-xs font-semibold text-slate-700 hover:bg-slate-50 dark:border-slate-600 dark:bg-slate-700 dark:text-slate-200 dark:hover:bg-slate-600">
                        <i class="fas fa-copy mr-1"></i>Copy JSON
                    </button>
                    <button id="closeRawDataModalBtn" class="rounded border border-[#E10000] bg-white px-3 py-1.5 text-xs font-semibold text-[#E10000] hover:bg-[#fff1f1] dark:border-red-700 dark:bg-slate-700 dark:text-red-400 dark:hover:bg-red-950/30">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentRepo = localStorage.getItem('currentRepo') || 'all';
        let allPrs = [];
        let repos = [];
        // Support unlimited sort columns
        // Each entry in sortColumns array has: {column: 'column_name', direction: 'asc'|'desc'}
        let sortColumns = [];
        try {
            const savedSort = localStorage.getItem('sortColumns');
            if (savedSort) {
                sortColumns = JSON.parse(savedSort);
            } else {
                // Migrate from old single/dual column format
                const oldPrimary = localStorage.getItem('sortColumn') || 'ready_score';
                const oldPrimaryDir = localStorage.getItem('sortDirection') || 'desc';
                sortColumns.push({ column: oldPrimary, direction: oldPrimaryDir });

                const oldSecondary = localStorage.getItem('secondarySortColumn');
                if (oldSecondary) {
                    const oldSecondaryDir = localStorage.getItem('secondarySortDirection') || 'desc';
                    sortColumns.push({ column: oldSecondary, direction: oldSecondaryDir });
                }
            }
        } catch (e) {
            // Fallback to default
            sortColumns = [{ column: 'ready_score', direction: 'desc' }];
        }

        // Ensure at least one sort column exists
        if (sortColumns.length === 0) {
            sortColumns = [{ column: 'ready_score', direction: 'desc' }];
        }
        let currentPage = 1;
        let totalPages = 1;
        // Load and validate perPage from localStorage
        let perPageRaw = localStorage.getItem('perPage');
        let perPageParsed = parseInt(perPageRaw, 10);
        let perPage = (!Number.isNaN(perPageParsed) && perPageParsed >= 10 && perPageParsed <= 1000)
            ? perPageParsed
            : 30; // Ensure perPage is within [10, 1000], fallback to 30 if invalid
        let activePrId = null; // Track the currently active/selected PR
        let detailPrId = null; // Right panel selected PR
        let activeStateFilter = 'all';
        let activeReviewFilter = 'all';
        let prRefreshHistory = {};
        try {
            prRefreshHistory = JSON.parse(localStorage.getItem('prRefreshHistory') || '{}');
        } catch (e) {
            prRefreshHistory = {};
        }

        // Auto-refresh state
        let autoRefreshEnabled = localStorage.getItem('autoRefreshEnabled') !== 'false'; // enabled by default
        let autoRefreshInterval = null;
        let prUpdateTimestamps = {}; // Track PR update timestamps for change detection
        let sidebarLastFocusedEl = null;
        const AUTO_REFRESH_INTERVAL = 30000; // 30 seconds
        function getPrListScrollElement() {
            const tableScroll = document.querySelector('#prListContainer .pr-table-scroll');
            return tableScroll || document.getElementById('prListPane');
        }

        function renderPanelPlaceholder(message) {
            const panelBody = document.getElementById('panelBody');
            if (panelBody) {
                panelBody.innerHTML = `<p class="text-xs italic text-slate-500 dark:text-slate-400">${escapeHtml(message)}</p>`;
            }
        }

        function updatePanelTopOffset() {
            const headerEl = document.querySelector('header');
            const headerHeight = headerEl ? Math.round(headerEl.getBoundingClientRect().height) : 64;
            document.documentElement.style.setProperty('--panel-top-offset', `${headerHeight}px`);
        }

        function updateSidebarTopOffset() {
            const mainContentEl = document.getElementById('mainContentArea');
            const topOffset = mainContentEl ? Math.max(0, Math.round(mainContentEl.getBoundingClientRect().top)) : 0;
            document.documentElement.style.setProperty('--sidebar-top-offset', `${topOffset}px`);
        }

        function isMobileSidebarViewport() {
            return window.matchMedia('(max-width: 1023px)').matches;
        }

        function isSidebarOpen() {
            if (isMobileSidebarViewport()) {
                return document.body.classList.contains('sidebar-open');
            }
            return !document.body.classList.contains('desktop-sidebar-collapsed');
        }

        function setSidebarToggleState(isOpen) {
            const toggleBtn = document.getElementById('sidebarToggleBtn');
            if (!toggleBtn) return;
            toggleBtn.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
            const icon = toggleBtn.querySelector('i');
            if (icon) {
                icon.className = isOpen ? 'fas fa-times' : 'fas fa-bars';
            }
        }

        function openSidebar() {
            sidebarLastFocusedEl = document.activeElement;
            if (isMobileSidebarViewport()) {
                document.body.classList.add('sidebar-open');
            } else {
                document.body.classList.remove('desktop-sidebar-collapsed');
            }
            setSidebarToggleState(true);
        }

        function closeSidebar(restoreFocus = false) {
            if (isMobileSidebarViewport()) {
                document.body.classList.remove('sidebar-open');
            } else {
                document.body.classList.add('desktop-sidebar-collapsed');
            }
            setSidebarToggleState(isSidebarOpen());
            if (restoreFocus && sidebarLastFocusedEl && typeof sidebarLastFocusedEl.focus === 'function') {
                sidebarLastFocusedEl.focus();
            }
            sidebarLastFocusedEl = null;
        }

        function toggleSidebar() {
            if (isSidebarOpen()) {
                closeSidebar(true);
            } else {
                openSidebar();
            }
        }

        function syncSidebarWithViewport() {
            if (isMobileSidebarViewport()) {
                document.body.classList.remove('desktop-sidebar-collapsed');
            } else {
                document.body.classList.remove('sidebar-open');
            }
            setSidebarToggleState(isSidebarOpen());
        }

        function updateMainContentHeight() {
            const mainContentEl = document.getElementById('mainContentArea');
            if (!mainContentEl) return;

            const topOffset = Math.max(0, Math.round(mainContentEl.getBoundingClientRect().top));
            const availableHeight = Math.max(260, window.innerHeight - topOffset);
            const heightPx = `${availableHeight}px`;
            document.documentElement.style.setProperty('--workspace-top-offset', `${topOffset}px`);
            mainContentEl.style.height = heightPx;
            mainContentEl.style.minHeight = '0';
        }

        function adjustPrTableHeight() {
            const listContainer = document.getElementById('prListContainer');
            const tableScroll = listContainer?.querySelector('.pr-table-scroll');
            if (!listContainer || !tableScroll) return;
            tableScroll.style.maxHeight = 'none';
        }

        // Helper functions for readiness data persistence
        function saveReadinessData(prId, readiness, reviewHealth) {
            try {
                const data = JSON.parse(localStorage.getItem('prReadinessData') || '{}');
                data[prId] = {
                    readiness,
                    reviewHealth,
                    timestamp: Date.now()
                };
                localStorage.setItem('prReadinessData', JSON.stringify(data));

                // Also update the PR object in allPrs for sorting
                const pr = allPrs.find(p => p.id === prId);
                if (pr) {
                    pr.ready_score = readiness.overall_score;
                    pr.ci_score = readiness.ci_score;
                    pr.review_score = readiness.review_score;
                    pr.response_score = parseFloat(reviewHealth.response_rate_display.replace('%', ''));
                    pr.feedback_score = reviewHealth.total_feedback > 0 ?
                        (reviewHealth.responded_feedback / reviewHealth.total_feedback) * 100 : 100;
                    pr.issues_count = (readiness.blockers?.length || 0) + (readiness.warnings?.length || 0);
                }
            } catch (error) {
                console.error('Error saving readiness data:', error);
            }
        }

        function loadReadinessData(prId) {
            try {
                const data = JSON.parse(localStorage.getItem('prReadinessData') || '{}');
                return data[prId] || null;
            } catch (error) {
                console.error('Error loading readiness data:', error);
                return null;
            }
        }

        function clearReadinessData(prId) {
            try {
                const data = JSON.parse(localStorage.getItem('prReadinessData') || '{}');
                delete data[prId];
                localStorage.setItem('prReadinessData', JSON.stringify(data));
            } catch (error) {
                console.error('Error clearing readiness data:', error);
            }
        }

        function saveRefreshHistory() {
            try {
                localStorage.setItem('prRefreshHistory', JSON.stringify(prRefreshHistory));
            } catch (e) {
                console.error('Error saving refresh history:', e);
            }
        }

        function addRefreshHistoryEntry(prId, previousScore, nextScore) {
            const id = String(prId);
            if (!prRefreshHistory[id]) prRefreshHistory[id] = [];
            const delta = (typeof previousScore === 'number' && typeof nextScore === 'number')
                ? Math.round(nextScore - previousScore)
                : null;
            prRefreshHistory[id].push({
                ts: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
                score: typeof nextScore === 'number' ? Math.round(nextScore) : null,
                delta
            });
            if (prRefreshHistory[id].length > 40) {
                prRefreshHistory[id] = prRefreshHistory[id].slice(-40);
            }
            saveRefreshHistory();
        }

        const repoItemBaseClasses = ['repo-item', 'cursor-pointer', 'rounded-lg', 'border', 'px-3', 'py-2', 'transition-colors'];
        const repoItemIdleClasses = ['border-slate-200', 'bg-white', 'hover:border-slate-300', 'hover:bg-slate-50', 'dark:border-slate-700', 'dark:bg-slate-800', 'dark:hover:border-slate-600', 'dark:hover:bg-slate-700'];
        const repoItemActiveClasses = ['active', 'border-[#f5b0b0]', 'bg-[#fff1f1]', 'dark:border-red-900', 'dark:bg-red-950/30'];

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function renderReviewerAvatars(reviewersJson) {
            let reviewers = [];
            try {
                if (typeof reviewersJson === 'string') {
                    reviewers = JSON.parse(reviewersJson);
                } else if (Array.isArray(reviewersJson)) {
                    reviewers = reviewersJson;
                }
            } catch (e) {
                return '<span class="text-xs text-slate-400 dark:text-slate-500">-</span>';
            }
            if (!reviewers || reviewers.length === 0) {
                return '<span class="text-xs text-slate-400 dark:text-slate-500">-</span>';
            }

            // Border color per review state
            const borderColor = {
                'APPROVED': 'border-emerald-400 dark:border-emerald-500',
                'CHANGES_REQUESTED': 'border-red-400 dark:border-red-500',
                'COMMENTED': 'border-amber-400 dark:border-amber-500',
                'PENDING': 'border-slate-300 dark:border-slate-500',
                'DISMISSED': 'border-slate-300 dark:border-slate-500'
            };

            const avatarHtml = reviewers.map((r, i) => {
                const ml = i > 0 ? 'margin-left: -6px;' : '';
                const zIndex = `z-index: ${reviewers.length - i};`;
                const border = borderColor[r.state] || borderColor['PENDING'];
                const safeAvatar = r.avatar_url &&
                    (r.avatar_url.startsWith('https://avatars.githubusercontent.com/') || r.avatar_url.startsWith('https://github.com/'))
                    ? escapeHtml(r.avatar_url)
                    : 'data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%2220%22 height=%2220%22%3E%3Crect width=%2220%22 height=%2220%22 fill=%22%23E2E8F0%22/%3E%3C/svg%3E';
                const stateLabel = r.state ? r.state.replace('_', ' ').toLowerCase() : 'pending';
                return `<img src="${safeAvatar}" alt="${escapeHtml(r.login)}" title="${escapeHtml(r.login)} (${stateLabel})" class="inline-block h-5 w-5 rounded-full border-2 ${border} bg-white dark:bg-slate-800" style="${ml} ${zIndex} position: relative;" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%2220%22 height=%2220%22%3E%3Crect width=%2220%22 height=%2220%22 fill=%22%23E2E8F0%22/%3E%3C/svg%3E'">`;
            }).join('');

            return `<div class="flex items-center" style="min-width: fit-content;">${avatarHtml}</div>`;
        }

        function setRepoItemActiveState(item, isActive) {
            item.className = '';
            item.classList.add(...repoItemBaseClasses);
            item.classList.add(...(isActive ? repoItemActiveClasses : repoItemIdleClasses));

            const nameEl = item.querySelector('.repo-name');
            if (nameEl) {
                nameEl.className = `repo-name text-sm font-semibold ${isActive ? 'text-[#BC0000] dark:text-red-400' : 'text-slate-800 dark:text-slate-200'}`;
            }
        }

        async function loadRateLimit() {
            try {
                const MS_PER_MINUTE = 60000;
                const MINUTES_PER_HOUR = 60;

                const response = await fetch('/api/rate-limit');
                const textEl = document.getElementById('rateLimitText');
                const fillEl = document.getElementById('rateLimitFill');
                const usedEl = document.getElementById('rateLimitUsed');
                const resetEl = document.getElementById('rateLimitReset');

                if (!response.ok) return;

                const data = await response.json();

                if (data.status === 'waiting_for_first_request') {
                    if (textEl) textEl.textContent = 'Ready';
                    if (usedEl) usedEl.textContent = '';
                    if (resetEl) resetEl.textContent = '';
                    if (fillEl) fillEl.style.width = '100%';
                    return;
                }
                if (data.error) {
                    if (textEl) textEl.textContent = 'N/A';
                    return;
                }

                const { limit, remaining, used, reset } = data;
                if (typeof limit !== 'number' || typeof remaining !== 'number') {
                    if (textEl) textEl.textContent = 'N/A';
                    return;
                }

                const percentageRemaining = (remaining / limit) * 100;

                if (fillEl) {
                    fillEl.style.width = `${percentageRemaining}%`;
                    fillEl.className = 'h-full rounded-full transition-all duration-300';
                    if (percentageRemaining < 20) {
                        fillEl.classList.add('bg-red-600');
                    } else if (percentageRemaining <= 50) {
                        fillEl.classList.add('bg-amber-500');
                    } else {
                        fillEl.classList.add('bg-green-500');
                    }
                }

                if (textEl) textEl.textContent = `${remaining} / ${limit}`;

                // Display used count
                if (usedEl && typeof used === 'number') {
                    usedEl.textContent = `(${used} used)`;
                }

                // Display reset time in human-readable format
                if (resetEl && typeof reset === 'number') {
                    const resetDate = new Date(reset * 1000);
                    const now = new Date();
                    const diffMs = resetDate - now;
                    const diffMins = Math.floor(diffMs / MS_PER_MINUTE);

                    if (diffMins <= 0) {
                        resetEl.textContent = 'Resets soon';
                    } else if (diffMins < MINUTES_PER_HOUR) {
                        resetEl.textContent = `Resets in ${diffMins}m`;
                    } else {
                        const diffHours = Math.floor(diffMins / MINUTES_PER_HOUR);
                        const remainingMins = diffMins % MINUTES_PER_HOUR;
                        if (remainingMins === 0) {
                            resetEl.textContent = `Resets in ${diffHours}h`;
                        } else {
                            resetEl.textContent = `Resets in ${diffHours}h ${remainingMins}m`;
                        }
                    }
                }

            } catch (error) {
                console.error('Error loading rate limit:', error);
                const textEl = document.getElementById('rateLimitText');
                const usedEl = document.getElementById('rateLimitUsed');
                const resetEl = document.getElementById('rateLimitReset');
                if (textEl) textEl.textContent = 'N/A';
                if (usedEl) usedEl.textContent = '';
                if (resetEl) resetEl.textContent = '';
            }
        }

        async function loadLatestRelease() {
            try {
                const response = await fetch('https://api.github.com/repos/OWASP-BLT/BLT-Leaf/releases/latest');

                if (!response.ok) {
                    return; // Silently fail - don't show version if API fails
                }

                const data = await response.json();
                const versionEl = document.getElementById('releaseVersion');

                if (data.tag_name && versionEl) {
                    versionEl.textContent = data.tag_name;
                    versionEl.classList.remove('hidden');
                }
            } catch (error) {
                console.error('Error loading latest release:', error);
                // Silently fail - don't show version if fetch fails
            }
        }

        function timeAgo(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const seconds = Math.floor((now - date) / 1000);
            const intervals = {
                year: 31536000,
                month: 2592000,
                week: 604800,
                day: 86400,
                hour: 3600,
                minute: 60
            };

            for (const [name, value] of Object.entries(intervals)) {
                const interval = Math.floor(seconds / value);
                if (interval >= 1) return `${interval} ${name}${interval === 1 ? '' : 's'} ago`;
            }

            return 'just now';
        }

        function sortPrs(column, isShiftClick = false) {
            if (isShiftClick) {
                // Shift+click adds or modifies additional sort columns
                const existingIndex = sortColumns.findIndex(sc => sc.column === column);

                if (existingIndex >= 0) {
                    // Column already in sort list - toggle its direction
                    sortColumns[existingIndex].direction =
                        sortColumns[existingIndex].direction === 'asc' ? 'desc' : 'asc';
                } else {
                    // Add new sort column
                    sortColumns.push({ column: column, direction: 'desc' });
                }
            } else {
                // Regular click - set as primary sort (first position)
                const existingIndex = sortColumns.findIndex(sc => sc.column === column);

                if (existingIndex === 0) {
                    // Already primary sort - toggle direction
                    sortColumns[0].direction = sortColumns[0].direction === 'asc' ? 'desc' : 'asc';
                } else if (existingIndex > 0) {
                    // Move to primary and toggle direction
                    const existing = sortColumns.splice(existingIndex, 1)[0];
                    existing.direction = existing.direction === 'asc' ? 'desc' : 'asc';
                    sortColumns.unshift(existing);
                } else {
                    // New primary sort column
                    sortColumns.unshift({ column: column, direction: 'desc' });
                }
            }

            // Save sorting state to localStorage
            localStorage.setItem('sortColumns', JSON.stringify(sortColumns));

            // Reset to first page when sorting changes
            currentPage = 1;

            // Reload PRs from server with new sort parameters
            loadPrs();
        }

        function showInlineError(rowId, message) {
            // Show error message in the specific PR row
            const row = document.getElementById(rowId);
            if (!row) return;

            // Create error cell that spans all columns
            const errorCell = document.createElement('td');
            errorCell.colSpan = 9; // Total number of columns in the compact table
            errorCell.className = 'px-2 py-3';
            errorCell.innerHTML = `
                <div class="flex items-start gap-2 rounded-lg border border-red-200 border-l-4 border-l-red-600 bg-red-50 px-3 py-2.5 text-sm text-red-900 dark:border-red-900 dark:bg-red-950/30 dark:text-red-400">
                    <span class="inline-flex h-5 w-5 flex-shrink-0 items-center justify-center rounded-full bg-red-100 text-xs font-bold text-red-700 dark:bg-red-900 dark:text-red-400">!</span>
                    <div class="leading-5">${escapeHtml(message)}</div>
                </div>
            `;

            // Replace all cells with the error cell
            row.innerHTML = '';
            row.appendChild(errorCell);
        }

        function showContainerError(containerId, message) {
            // Show error message in a container (for loading errors)
            const container = document.getElementById(containerId);
            if (!container) return;

            container.innerHTML = `
                <div class="rounded-xl border border-red-200 bg-white p-8 dark:border-red-900 dark:bg-slate-800">
                    <div class="flex items-start gap-3">
                        <span class="inline-flex h-8 w-8 flex-shrink-0 items-center justify-center rounded-full bg-red-100 text-sm font-bold text-red-700 dark:bg-red-900 dark:text-red-400">!</span>
                        <div>
                            <h3 class="text-lg font-semibold text-slate-900 dark:text-slate-100 mb-2">Error</h3>
                            <p class="text-sm text-slate-700 dark:text-slate-300">${escapeHtml(message)}</p>
                        </div>
                    </div>
                </div>
            `;
        }

        function showInputError(inputId, message) {
            // Show error message near an input field
            const input = document.getElementById(inputId);
            if (!input) return;

            // Remove any existing error message
            const container = input.closest('section');
            const existingError = container.querySelector('.input-error-message');
            if (existingError) {
                existingError.remove();
            }

            // Create error message element
            const errorElement = document.createElement('div');
            errorElement.className = 'input-error-message flex items-start gap-2 rounded-lg border border-red-200 bg-red-50 px-3 py-2 text-sm text-red-900 dark:border-red-900 dark:bg-red-950/30 dark:text-red-400 w-full max-w-4xl';
            errorElement.innerHTML = `
                <span class="inline-flex h-5 w-5 flex-shrink-0 items-center justify-center rounded-full bg-red-100 text-xs font-bold text-red-700 dark:bg-red-900 dark:text-red-400">!</span>
                <div class="leading-5">${escapeHtml(message)}</div>
            `;

            // Insert after the parent flex div
            const parentDiv = input.parentElement;
            parentDiv.after(errorElement);

            // Auto-remove after 5 seconds
            setTimeout(() => {
                errorElement.remove();
            }, 5000);
        }

        async function loadRepos() {
            try {
                const response = await fetch('/api/repos');
                const data = await response.json();

                if (data.error) {
                    console.error('Error loading repos:', data.error);
                    return;
                }

                repos = data.repos;
                renderRepoList();
            } catch (error) {
                console.error('Error loading repos:', error);
            }
        }

        function renderRepoList() {
            const repoList = document.getElementById('repoList');
            const allReposCount = document.getElementById('allReposCount');
            const repoCountDisplay = document.getElementById('repoCountDisplay');
            const totalPrs = repos.reduce((sum, repo) => sum + repo.pr_count, 0);
            allReposCount.textContent = `${totalPrs} PR${totalPrs === 1 ? '' : 's'}`;

            // Update the repository count display
            const repoCount = repos.length;
            repoCountDisplay.textContent = repoCount > 0 ? `(${repoCount})` : '';

            while (repoList.children.length > 1) repoList.removeChild(repoList.lastChild);

            const allItem = repoList.querySelector('[data-repo="all"]');
            if (allItem) setRepoItemActiveState(allItem, currentRepo === 'all');

            repos.forEach(repo => {
                const li = document.createElement('li');
                li.dataset.repo = `${repo.repo_owner}/${repo.repo_name}`;
                setRepoItemActiveState(li, currentRepo === li.dataset.repo);

                li.innerHTML = `
                    <div class="flex items-center justify-between">
                        
                        <div>
                            <div class="repo-name text-sm font-semibold text-slate-800 dark:text-slate-200">
                                ${repo.repo_owner}/${repo.repo_name}
                            </div>

                            <div class="repo-count mt-0.5 text-xs text-slate-500 dark:text-slate-400">
                                ${repo.pr_count} PR${repo.pr_count === 1 ? '' : 's'}
                            </div>
                        </div>

                        <div class="flex items-center gap-2">
                            <button
                                class="add-all-prs-btn text-slate-500 hover:text-[#BC0000] dark:hover:text-red-400 p-2 rounded hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors"
                                title="Import all PRs from this repository"
                                aria-label="Import all pull requests from this repository"
                                data-repo-owner="${repo.repo_owner}"
                                data-repo-name="${repo.repo_name}">
                                <i class="fas fa-plus text-xl text-red-600 hover:text-red-700 transition-colors"></i>
                            </button>

                            <a href="https://github.com/${repo.repo_owner}/${repo.repo_name}/pulls"
                            target="_blank"
                            rel="noopener noreferrer"
                            class="text-slate-500 hover:text-[#BC0000] dark:hover:text-red-400 github-pr-link"
                            title="View Pull Requests on GitHub"
                            onclick="event.stopPropagation();">

                                <i class="fab fa-github text-lg text-red-600 hover:text-red-700 transition-colors"></i>


                            </a>
                        </div>

                    </div>
                `;

                li.addEventListener('click', () => {
                    currentPage = 1;
                    currentRepo = li.dataset.repo;
                    localStorage.setItem('currentRepo', currentRepo);
                    document.querySelectorAll('.repo-item').forEach(item => {
                        setRepoItemActiveState(item, item.dataset.repo === currentRepo);
                    });
                    if (isMobileSidebarViewport()) closeSidebar();
                    loadPrs();
                });

                repoList.appendChild(li);
            });
        }

        async function loadPrs() {
            const container = document.getElementById('prListContainer');
            // Only show spinner if search is empty to avoid flickering while typing
            if (document.getElementById('prSearchInput').value.trim() === '' && !container.querySelector('table')) {
                container.innerHTML = `
                    <div class="flex items-center justify-center gap-2 rounded-xl border border-slate-200 bg-white p-8 text-sm text-slate-500 dark:border-slate-700 dark:bg-slate-800 dark:text-slate-400">
                        <span class="inline-block h-4 w-4 animate-spin rounded-full border-2 border-slate-300 border-t-slate-500 dark:border-slate-600 dark:border-t-slate-400"></span>
                        Loading PRs...
                    </div>
                `;
            }

            try {
                // Build sort parameters from sortColumns array
                let sortByParam = sortColumns.map(sc => sc.column).join(',');
                let sortDirParam = sortColumns.map(sc => sc.direction).join(',');

                // Build URL with pagination and sorting parameters
                let url;
                if (currentRepo === 'all') {
                    url = `/api/prs?page=${currentPage}&per_page=${perPage}&sort_by=${sortByParam}&sort_dir=${sortDirParam}`;
                } else {
                    url = `/api/prs?repo=${encodeURIComponent(currentRepo)}&page=${currentPage}&per_page=${perPage}&sort_by=${sortByParam}&sort_dir=${sortDirParam}`;
                }

                const response = await fetch(url);
                const data = await response.json();

                if (data.error) {
                    showContainerError('prListContainer', data.error);
                    return;
                }

                allPrs = data.prs;
                if (data.pagination) {
                    totalPages = data.pagination.total_pages;
                    if (currentPage > totalPages && totalPages > 0) {
                        currentPage = totalPages;
                    }
                }

                // Attach readiness data from localStorage to each PR for display and computed columns
                allPrs.forEach(pr => {
                    // First, try to get readiness data from database (if it exists)
                    if (pr.overall_score !== null && pr.overall_score !== undefined) {
                        pr.ready_score = pr.overall_score;
                        // ci_score and review_score are already in the pr object from database
                        pr.response_score = (pr.response_rate || 0) * 100;
                        pr.feedback_score = pr.total_feedback > 0 ?
                            (pr.responded_feedback / pr.total_feedback) * 100 : 100;

                        // Parse blockers and warnings to get issues count
                        try {
                            const blockers = pr.blockers ? JSON.parse(pr.blockers) : [];
                            const warnings = pr.warnings ? JSON.parse(pr.warnings) : [];
                            pr.issues_count = blockers.length + warnings.length;
                        } catch (e) {
                            pr.issues_count = 0;
                        }
                    } else {
                        // Fall back to localStorage if database doesn't have readiness data
                        const storedData = loadReadinessData(pr.id);
                        if (storedData && storedData.readiness && storedData.reviewHealth) {
                            pr.ready_score = storedData.readiness.overall_score;
                            pr.ci_score = storedData.readiness.ci_score;
                            pr.review_score = storedData.readiness.review_score;
                            pr.response_score = parseFloat(storedData.reviewHealth.response_rate_display.replace('%', ''));
                            pr.feedback_score = storedData.reviewHealth.total_feedback > 0 ?
                                (storedData.reviewHealth.responded_feedback / storedData.reviewHealth.total_feedback) * 100 : 100;
                            pr.issues_count = (storedData.readiness.blockers?.length || 0) + (storedData.readiness.warnings?.length || 0);
                        }
                    }
                });

                // Only apply client-side sorting for computed columns (issues_count)
                // All other columns are already sorted by the backend
                if (sortColumns.length > 0 && sortColumns[0].column === 'issues_count') {
                    const primaryDirection = sortColumns[0].direction;
                    allPrs.sort((a, b) => {
                        let aVal = Number(a.issues_count) || 0;
                        let bVal = Number(b.issues_count) || 0;

                        if (primaryDirection === 'asc') {
                            return aVal > bVal ? 1 : aVal < bVal ? -1 : 0;
                        } else {
                            return aVal < bVal ? 1 : aVal > bVal ? -1 : 0;
                        }
                    });
                }

                applyClientFilters();
            } catch (error) {
                console.error('Error loading PRs:', error);
                showContainerError('prListContainer', 'Failed to load PRs');
            }
        }

        function applyClientFilters() {
            const term = (document.getElementById('prSearchInput').value || '').trim().toLowerCase();
            let filtered = allPrs.slice();

            if (activeStateFilter !== 'all') {
                filtered = filtered.filter(pr => {
                    if (activeStateFilter === 'draft') return pr.is_draft == 1;
                    if (activeStateFilter === 'open') return pr.state === 'open' && pr.is_draft != 1;
                    return true;
                });
            }

            if (activeReviewFilter !== 'all') {
                filtered = filtered.filter(pr => pr.review_status === activeReviewFilter);
            }

            if (term) {
                filtered = filtered.filter(pr =>
                    (pr.title && pr.title.toLowerCase().includes(term)) ||
                    (pr.author_login && pr.author_login.toLowerCase().includes(term)) ||
                    (pr.repo_name && pr.repo_name.toLowerCase().includes(term)) ||
                    String(pr.pr_number).includes(term)
                );
            }

            renderPrList(filtered);
        }

        function filterPrs(searchTerm) {
            const input = document.getElementById('prSearchInput');
            if (typeof searchTerm === 'string' && input) {
                input.value = searchTerm;
            }
            applyClientFilters();
        }

        /**
         * Check for PR updates by fetching lightweight timestamp data
         * Compare with local cache to detect changes
         */
        async function checkForPrUpdates() {
            if (!autoRefreshEnabled) return;

            try {
                const response = await fetch('/api/prs/updates');
                const data = await response.json();

                if (data.error) {
                    console.error('Error checking for updates:', data.error);
                    return;
                }

                const updates = data.updates || [];
                const changedPrIds = [];
                const removedPrIds = [];

                // Detect changes
                updates.forEach(update => {
                    const oldTimestamp = prUpdateTimestamps[update.id];
                    if (oldTimestamp && oldTimestamp !== update.updated_at) {
                        changedPrIds.push(update.id);
                    }
                    prUpdateTimestamps[update.id] = update.updated_at;
                });

                // Detect removals (PRs that were in cache but not in update)
                // Use Set for O(1) lookup instead of O(n) find operation
                const currentPrIds = new Set(updates.map(u => u.id));
                Object.keys(prUpdateTimestamps).forEach(prId => {
                    const prIdNum = parseInt(prId);
                    if (!currentPrIds.has(prIdNum)) {
                        removedPrIds.push(prIdNum);
                        delete prUpdateTimestamps[prId];
                    }
                });

                // Handle removed PRs with animation
                if (removedPrIds.length > 0) {
                    for (const prId of removedPrIds) {
                        await removePrWithAnimation(prId);
                    }

                    // Check if all PRs were removed and render empty state if needed
                    // Note: allPrs array is updated synchronously in removePrWithAnimation()
                    if (allPrs.length === 0) {
                        renderPrList(allPrs);
                    }
                }

                // Reload if there are changes (not removals, as those are already handled)
                if (changedPrIds.length > 0) {
                    console.log('PR updates detected, refreshing...');
                    await loadPrs();
                }

                // Update repo counts if there were any changes or removals
                if (changedPrIds.length > 0 || removedPrIds.length > 0) {
                    await loadRepos();
                }
            } catch (error) {
                console.error('Error checking for PR updates:', error);
            }
        }

        /**
         * Remove a PR from the UI with animation
         */
        async function removePrWithAnimation(prId) {
            // Remove from allPrs array
            const prIndex = allPrs.findIndex(pr => pr.id === prId);
            if (prIndex !== -1) {
                allPrs.splice(prIndex, 1);
            }

            // Get the row element
            const row = document.getElementById(`pr-row-${prId}`);
            if (row) {
                // Add fade-out animation
                row.style.transition = 'opacity 0.3s ease-out, transform 0.3s ease-out';
                row.style.opacity = '0';
                row.style.transform = 'translateX(20px)';

                // Remove the row after animation completes
                await new Promise(resolve => setTimeout(resolve, 300));
                row.remove();
            }
        }

        /**
         * Start auto-refresh polling
         */
        async function startAutoRefresh() {
            if (autoRefreshInterval) return; // Already running

            autoRefreshEnabled = true;
            localStorage.setItem('autoRefreshEnabled', 'true');

            // Initial check (await to handle errors properly)
            await checkForPrUpdates();

            // Set up interval
            autoRefreshInterval = setInterval(checkForPrUpdates, AUTO_REFRESH_INTERVAL);

            // Update UI
            updateAutoRefreshUI();
        }

        /**
         * Stop auto-refresh polling
         */
        function stopAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
            }

            autoRefreshEnabled = false;
            localStorage.setItem('autoRefreshEnabled', 'false');

            // Update UI
            updateAutoRefreshUI();
        }

        /**
         * Toggle auto-refresh on/off
         */
        function toggleAutoRefresh() {
            if (autoRefreshEnabled) {
                stopAutoRefresh();
            } else {
                startAutoRefresh();
            }
        }

        /**
         * Update the auto-refresh button appearance
         */
        function updateAutoRefreshUI() {
            const button = document.getElementById('autoRefreshToggle');
            const icon = document.getElementById('autoRefreshIcon');

            if (autoRefreshEnabled) {
                button.classList.add('text-green-600', 'dark:text-green-400');
                button.classList.remove('text-slate-500', 'dark:text-slate-400');
                icon.classList.add('fa-spin');
                button.title = 'Auto-refresh enabled (click to disable)';
            } else {
                button.classList.remove('text-green-600', 'dark:text-green-400');
                button.classList.add('text-slate-500', 'dark:text-slate-400');
                icon.classList.remove('fa-spin');
                button.title = 'Auto-refresh disabled (click to enable)';
            }
        }

        /**
         * Pause auto-refresh when tab is not visible (optimization)
         */
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                // Clear interval when tab is hidden
                if (autoRefreshInterval) {
                    clearInterval(autoRefreshInterval);
                    autoRefreshInterval = null;
                }
            } else {
                // Resume polling when tab becomes visible (only if auto-refresh is enabled)
                if (autoRefreshEnabled && !autoRefreshInterval) {
                    autoRefreshInterval = setInterval(checkForPrUpdates, AUTO_REFRESH_INTERVAL);
                    checkForPrUpdates(); // Check immediately on tab becoming visible
                }
            }
        });

        function renderPrList(prsToRender) {
            const container = document.getElementById('prListContainer');
            const prs = prsToRender || allPrs || [];
            const listScrollContainer = getPrListScrollElement();
            const previousMainScrollTop = listScrollContainer ? listScrollContainer.scrollTop : 0;

            if (prs.length === 0) {
                const hasSearch = document.getElementById('prSearchInput').value.trim() !== '';
                const hasFilters = activeStateFilter !== 'all' || activeReviewFilter !== 'all';
                const emptyTitle = (hasSearch || hasFilters) ? 'No PRs Match' : 'No PRs Added Yet';
                container.innerHTML = `
                    <div class="rounded-xl border border-dashed border-slate-300 bg-white p-10 text-center dark:border-slate-600 dark:bg-slate-800">
                        <h3 class="text-xl font-semibold text-slate-900 dark:text-slate-100">${emptyTitle}</h3>
                        <p class="mt-2 text-sm text-slate-500 dark:text-slate-400">Add a GitHub PR URL above to start tracking</p>
                    </div>
                `;
                if (listScrollContainer) {
                    listScrollContainer.scrollTop = previousMainScrollTop;
                }
                return;
            }

            const getSortIcon = (column) => {
                const sortIndex = sortColumns.findIndex(sc => sc.column === column);
                if (sortIndex >= 0) {
                    const sortCol = sortColumns[sortIndex];
                    if (sortIndex === 0) {
                        return sortCol.direction === 'asc'
                            ? '<i class="fas fa-sort-up text-[#BC0000] dark:text-red-400 ml-1"></i>'
                            : '<i class="fas fa-sort-down text-[#BC0000] dark:text-red-400 ml-1"></i>';
                    }
                    const number = sortIndex + 1;
                    const secondaryIcon = sortCol.direction === 'asc'
                        ? '<i class="fas fa-sort-up text-slate-500 dark:text-slate-400 ml-1" style="font-size:0.75em;"></i>'
                        : '<i class="fas fa-sort-down text-slate-500 dark:text-slate-400 ml-1" style="font-size:0.75em;"></i>';
                    return secondaryIcon;
                }
                return '<i class="fas fa-sort text-slate-400 ml-1"></i>';
            };

            container.innerHTML = `
                <div class="mb-2 flex flex-wrap items-center gap-2 rounded-lg border border-slate-200 bg-white px-2.5 py-1 dark:border-slate-700 dark:bg-slate-800">
                    <div class="mr-1 text-[10px] font-semibold uppercase tracking-wider text-slate-500 dark:text-slate-400">Filters</div>
                    <button class="filter-chip ${activeStateFilter === 'all' ? 'active' : ''}" data-filter-type="state" data-filter-value="all">All</button>
                    <button class="filter-chip ${activeStateFilter === 'open' ? 'active' : ''}" data-filter-type="state" data-filter-value="open">Open</button>
                    <button class="filter-chip ${activeStateFilter === 'draft' ? 'active' : ''}" data-filter-type="state" data-filter-value="draft">Draft</button>
                    <span class="mx-1 h-4 w-px bg-slate-200 dark:bg-slate-700"></span>
                    <button class="filter-chip ${activeReviewFilter === 'all' ? 'active' : ''}" data-filter-type="review" data-filter-value="all">Review: All</button>
                    <button class="filter-chip ${activeReviewFilter === 'approved' ? 'active' : ''}" data-filter-type="review" data-filter-value="approved">Approved</button>
                    <button class="filter-chip ${activeReviewFilter === 'changes_requested' ? 'active' : ''}" data-filter-type="review" data-filter-value="changes_requested">Changes</button>
                    <button class="filter-chip ${activeReviewFilter === 'pending' ? 'active' : ''}" data-filter-type="review" data-filter-value="pending">Pending</button>
                    <div class="ml-auto flex items-center gap-2">
                        <button id="clearSortBtn" class="filter-chip" title="Clear all sorting and reset to default (Ready Score)">
                            <i class="fas fa-times-circle"></i> Clear Sort
                        </button>
                        <button id="sortByReadinessBtn" class="filter-chip" title="Sort by Readiness Score (Ready column)">
                            <i class="fas fa-sort-amount-down"></i> By Score
                        </button>
                        <span class="rounded-full bg-slate-100 px-2 py-1 text-[10px] font-semibold text-slate-600 dark:bg-slate-700 dark:text-slate-300">${prs.length} PR${prs.length === 1 ? '' : 's'}</span>
                    </div>
                </div>
                <div class="flex h-full min-h-0 flex-1 flex-col rounded-xl border border-slate-200 bg-white dark:border-slate-700 dark:bg-slate-800">
                    <div class="pr-table-scroll h-full min-h-0 flex-1 overflow-x-auto overflow-y-auto">
                        <table class="w-full table-fixed min-w-[780px] text-left text-sm">
                            <thead class="border-b border-slate-200 bg-slate-50 text-xs font-semibold uppercase tracking-wider text-slate-700 dark:border-slate-700 dark:bg-slate-900/50 dark:text-slate-300">
                                <tr>
                                    <th class="cursor-pointer px-1.5 py-2.5 hover:bg-slate-100 dark:hover:bg-slate-900" data-sort-column="author_login" style="width:10%"><div class="flex items-center gap-1 truncate"><span class="truncate">Author</span> ${getSortIcon('author_login')}</div></th>
                                    <th class="cursor-pointer px-1.5 py-2.5 hover:bg-slate-100 dark:hover:bg-slate-900" data-sort-column="title" style="width:25%"><div class="flex items-center gap-1 truncate"><span class="truncate">PR</span> ${getSortIcon('title')}</div></th>
                                    <th class="cursor-pointer px-1.5 py-2.5 hover:bg-slate-100 dark:hover:bg-slate-900" data-sort-column="repo_owner" style="width:12%"><div class="flex items-center gap-1 truncate"><span class="truncate">Repo</span> ${getSortIcon('repo_owner')}</div></th>
                                    <th class="cursor-pointer px-1.5 py-2.5 hover:bg-slate-100 dark:hover:bg-slate-900" data-sort-column="review_status" style="width:9%"><div class="flex items-center gap-1 truncate"><span class="truncate">Review</span> ${getSortIcon('review_status')}</div></th>
                                    <th class="cursor-pointer px-1.5 py-2.5 hover:bg-slate-100 dark:hover:bg-slate-900" data-sort-column="checks_passed" style="width:11%"><div class="flex items-center gap-1 truncate"><span class="truncate">Health</span> ${getSortIcon('checks_passed')}</div></th>
                                    <th class="cursor-pointer px-1.5 py-2.5 text-center hover:bg-slate-100 dark:hover:bg-slate-900" data-sort-column="ready" style="width:6%"><div class="flex items-center justify-center gap-1 truncate"><span class="truncate">Ready</span> ${getSortIcon('ready')}</div></th>
                                    <th class="cursor-pointer px-1.5 py-2.5 text-center hover:bg-slate-100 dark:hover:bg-slate-900" data-sort-column="ready_score" style="width:6%"><div class="flex items-center justify-center gap-1 truncate"><span class="truncate">Score</span> ${getSortIcon('ready_score')}</div></th>
                                    <th class="cursor-pointer px-1.5 py-2.5 hover:bg-slate-100 dark:hover:bg-slate-900" data-sort-column="last_updated_at" style="width:7%"><div class="flex items-center gap-1 truncate"><span class="truncate">Updated</span> ${getSortIcon('last_updated_at')}</div></th>
                                    <th class="px-1.5 py-2.5 text-center whitespace-nowrap" style="width:96px">Action</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-slate-200 dark:divide-slate-700" id="prTableBody"></tbody>
                        </table>
                    </div>
                    <div id="paginationMount" class="pagination-wrapper flex items-center justify-between shrink-0 border-t border-slate-700 bg-slate-900/40 px-4 py-3"></div>
                </div>
            `;

            const tbody = document.getElementById('prTableBody');
            prs.forEach(pr => {
                const row = createPrRow(pr);
                tbody.appendChild(row);

                let readiness = null;
                let reviewHealth = null;

                if (pr.overall_score !== null && pr.overall_score !== undefined) {
                    try {
                        const blockers = pr.blockers ? JSON.parse(pr.blockers) : [];
                        const warnings = pr.warnings ? JSON.parse(pr.warnings) : [];
                        const recommendations = pr.recommendations ? JSON.parse(pr.recommendations) : [];
                        const staleFeedback = pr.stale_feedback ? JSON.parse(pr.stale_feedback) : [];

                        readiness = {
                            overall_score: pr.overall_score,
                            overall_score_display: `${pr.overall_score}%`,
                            ci_score: pr.ci_score,
                            ci_score_display: `${pr.ci_score}%`,
                            review_score: pr.review_score,
                            review_score_display: `${pr.review_score}%`,
                            classification: pr.classification,
                            merge_ready: pr.merge_ready === 1,
                            blockers,
                            warnings,
                            recommendations
                        };

                        reviewHealth = {
                            classification: pr.review_health_classification,
                            score: pr.review_health_score,
                            score_display: `${pr.review_health_score || 0}%`,
                            response_rate: pr.response_rate || 0,
                            response_rate_display: `${Math.round((pr.response_rate || 0) * 100)}%`,
                            total_feedback: pr.total_feedback || 0,
                            responded_feedback: pr.responded_feedback || 0,
                            stale_feedback_count: pr.stale_feedback_count || 0,
                            stale_feedback: staleFeedback
                        };
                    } catch (e) {
                        console.error('Error parsing readiness data from database:', e);
                    }
                }

                if (!readiness || !reviewHealth) {
                    const storedData = loadReadinessData(pr.id);
                    if (storedData && storedData.readiness && storedData.reviewHealth) {
                        readiness = storedData.readiness;
                        reviewHealth = storedData.reviewHealth;
                    }
                }

                if (readiness && reviewHealth) {
                    updateInlineCells(pr.id, readiness, reviewHealth);
                    const updateBtn = row.querySelector('.update-btn');
                    if (updateBtn) {
                        updateBtn.innerHTML = '<i class="fas fa-check mr-1"></i>Updated';
                    }
                    if (detailPrId === pr.id) {
                        renderDetailPanelBody(pr.id);
                    }
                }
            });

            document.querySelectorAll('.update-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const prId = e.currentTarget.dataset.prId;
                    await updatePr(prId, e.currentTarget);
                });
            });
            document.querySelectorAll('.view-raw-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const prId = e.currentTarget.dataset.prId;
                    showRawDataModal(prId);
                });
            });
            adjustPrTableHeight();
            
            renderPagination(true);
            if (listScrollContainer) {
                listScrollContainer.scrollTop = previousMainScrollTop;
            }
        }

        function renderPagination(showPagination = true) {
            const container = document.getElementById('prListContainer');
            const paginationMount = document.getElementById('paginationMount');
            if (!container || !paginationMount) return;

            if (!showPagination) {
                paginationMount.innerHTML = '';
                paginationMount.classList.add('hidden');
                return;
            }

            paginationMount.classList.remove('hidden');

            paginationMount.innerHTML = `
                <div class="flex items-center gap-4">
                    <div class="text-sm text-slate-600 dark:text-slate-400">
                        Page <span class="font-semibold">${currentPage}</span> of <span class="font-semibold">${totalPages}</span>
                    </div>
                    <div class="flex items-center gap-2 text-sm text-slate-600 dark:text-slate-400">
                        <label for="pageSizeSelect" class="whitespace-nowrap">Items per page:</label>
                        <select 
                            id="pageSizeSelect" 
                            class="px-2 py-1 rounded-lg border border-slate-300 bg-white text-slate-900 text-sm 
                                   dark:bg-slate-800 dark:border-slate-600 dark:text-slate-100 
                                   focus:outline-none focus:ring-2 focus:ring-red-500 dark:focus:ring-red-400">
                            <option value="10" ${perPage === 10 ? 'selected' : ''}>10</option>
                            <option value="25" ${perPage === 25 ? 'selected' : ''}>25</option>
                            <option value="30" ${perPage === 30 ? 'selected' : ''}>30</option>
                            <option value="50" ${perPage === 50 ? 'selected' : ''}>50</option>
                            <option value="100" ${perPage === 100 ? 'selected' : ''}>100</option>
                            <option value="250" ${perPage === 250 ? 'selected' : ''}>250</option>
                            <option value="500" ${perPage === 500 ? 'selected' : ''}>500</option>
                            <option value="1000" ${perPage === 1000 ? 'selected' : ''}>1000</option>
                        </select>
                    </div>
                </div>
            <div class="flex gap-2">
                <button 
                    ${currentPage === 1 ? 'disabled' : ''} 
                    class="px-4 py-2 rounded-lg border text-sm font-semibold transition-all
                           ${currentPage === 1
                    ? 'bg-slate-200 text-slate-400 cursor-not-allowed dark:bg-slate-700 dark:text-slate-500'
                    : 'bg-white hover:bg-red-50 border-slate-300 hover:border-red-300 dark:bg-slate-800 dark:hover:bg-slate-700'}"
                    id="prevPageBtn">  Previous
                </button>

                <button 
                    ${currentPage === totalPages ? 'disabled' : ''} 
                    class="px-4 py-2 rounded-lg border text-sm font-semibold transition-all
                            ${currentPage === totalPages
                    ? 'bg-slate-200 text-slate-400 cursor-not-allowed dark:bg-slate-700 dark:text-slate-500'
                    : 'bg-white hover:bg-red-50 border-slate-300 hover:border-red-300 dark:bg-slate-800 dark:hover:bg-slate-700'}"
                    id="nextPageBtn"> Next 
                </button>
            </div>
        `;

            adjustPrTableHeight();

            document.getElementById('prevPageBtn')?.addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    loadPrs();
                }
            });
            document.getElementById('nextPageBtn')?.addEventListener('click', () => {
                if (currentPage < totalPages) {
                    currentPage++;
                    loadPrs();
                }
            });
            
            // Handle page size change
            document.getElementById('pageSizeSelect')?.addEventListener('change', (e) => {
                const newPerPage = parseInt(e.target.value, 10);
                
                // Validate the new page size to guard against DOM manipulation
                if (Number.isNaN(newPerPage) || newPerPage < 10 || newPerPage > 1000) {
                    // Revert the select value to the current perPage if invalid
                    e.target.value = perPage.toString();
                    return;
                }
                
                if (newPerPage !== perPage) {
                    perPage = newPerPage;
                    localStorage.setItem('perPage', perPage.toString());
                    currentPage = 1; // Reset to first page when changing page size
                    loadPrs();
                }
            });
        }

        function createPrRow(pr) {
            let reviewBadge = '';
            if (pr.review_status === 'approved') {
                reviewBadge = '<span class="inline-flex rounded-full border border-emerald-200 bg-emerald-50 px-2 py-0.5 text-xs font-semibold text-emerald-700 dark:border-emerald-900 dark:bg-emerald-950/30 dark:text-emerald-400">Approved</span>';
            } else if (pr.review_status === 'changes_requested') {
                reviewBadge = '<span class="inline-flex rounded-full border border-red-200 bg-red-50 px-2 py-0.5 text-xs font-semibold text-red-700 dark:border-red-900 dark:bg-red-950/30 dark:text-red-400">Changes</span>';
            } else if (pr.review_status === 'pending') {
                reviewBadge = '<span class="inline-flex rounded-full border border-amber-200 bg-amber-50 px-2 py-0.5 text-xs font-semibold text-amber-700 dark:border-amber-900 dark:bg-amber-950/30 dark:text-amber-400">Pending</span>';
            } else {
                reviewBadge = '<span class="inline-flex rounded-full border border-slate-200 bg-slate-100 px-2 py-0.5 text-xs font-semibold text-slate-600 dark:border-slate-700 dark:bg-slate-700 dark:text-slate-300">None</span>';
            }

            const avatarUrl = pr.author_avatar &&
                (pr.author_avatar.startsWith('https://avatars.githubusercontent.com/') || pr.author_avatar.startsWith('https://github.com/'))
                ? pr.author_avatar
                : 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="32" height="32"%3E%3Crect width="32" height="32" fill="%23E2E8F0"/%3E%3C/svg%3E';

            const repoOwnerAvatarUrl = pr.repo_owner_avatar &&
                (pr.repo_owner_avatar.startsWith('https://avatars.githubusercontent.com/') || pr.repo_owner_avatar.startsWith('https://github.com/'))
                ? pr.repo_owner_avatar
                : 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="32" height="32"%3E%3Crect width="32" height="32" fill="%23E2E8F0"/%3E%3C/svg%3E';

            const truncatedTitle = pr.title && pr.title.length > 48 ? pr.title.substring(0, 48) + '...' : pr.title;

            const row = document.createElement('tr');
            row.className = 'pr-row-select hover:bg-slate-50 dark:hover:bg-slate-900/50';
            row.id = `pr-row-${pr.id}`;
            row.innerHTML = `
                <td class="px-1.5 py-2.5">
                    <div class="flex items-center gap-2 min-w-0">
                        <img src="${escapeHtml(avatarUrl)}" alt="${escapeHtml(pr.author_login)}" class="h-5 w-5 rounded-full border border-slate-200 dark:border-slate-600 flex-shrink-0" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%2220%22 height=%2220%22%3E%3Crect width=%2220%22 height=%2220%22 fill=%22%23E2E8F0%22/%3E%3C/svg%3E'">
                        <span class="text-xs text-slate-700 dark:text-slate-300 truncate">${escapeHtml(pr.author_login)}</span>
                    </div>
                </td>
                <td class="px-1.5 py-2.5">
                    <div class="flex items-center gap-2 min-w-0">
                        <img src="${escapeHtml(repoOwnerAvatarUrl)}" alt="${escapeHtml(pr.repo_owner)}" class="h-5 w-5 rounded-full border border-slate-200 dark:border-slate-600 flex-shrink-0" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%2220%22 height=%2220%22%3E%3Crect width=%2220%22 height=%2220%22 fill=%22%23E2E8F0%22/%3E%3C/svg%3E'">
                        <a href="${escapeHtml(pr.pr_url)}" target="_blank" rel="noopener noreferrer" class="font-semibold text-slate-900 hover:text-[#BC0000] dark:text-slate-100 dark:hover:text-red-400 truncate text-xs" title="${escapeHtml(pr.title)}">${escapeHtml(truncatedTitle)}</a>
                    </div>
                </td>
                <td class="px-1.5 py-2.5 text-slate-600 dark:text-slate-400">
                    <div class="truncate text-xs">${escapeHtml(pr.repo_owner)}/${escapeHtml(pr.repo_name)}</div>
                    <div class="text-[10px] text-slate-500 dark:text-slate-500">#${pr.pr_number}</div>
                </td>
                <td class="px-1.5 py-2.5">${reviewBadge}</td>
                <td class="px-1.5 py-2.5">
                    <div class="flex flex-wrap gap-1 text-[11px]">
                        <span class="inline-flex items-center gap-1 rounded border border-emerald-200 bg-emerald-50 px-1 py-0.5 text-emerald-700 dark:border-emerald-900 dark:bg-emerald-950/30 dark:text-emerald-400">
                            <i class="fas fa-check-circle"></i>${pr.checks_passed}
                        </span>
                        ${pr.checks_failed > 0 ? `<span class="inline-flex items-center gap-1 rounded border border-red-200 bg-red-50 px-1 py-0.5 text-red-700 dark:border-red-900 dark:bg-red-950/30 dark:text-red-400"><i class="fas fa-times-circle"></i>${pr.checks_failed}</span>` : ''}
                        <span class="inline-flex items-center gap-1 rounded border border-slate-200 bg-slate-100 px-1 py-0.5 text-slate-600 dark:border-slate-700 dark:bg-slate-700 dark:text-slate-400">
                            <i class="fas fa-comment-dots"></i>${pr.open_conversations_count || 0}
                        </span>
                    </div>
                </td>
                <td class="px-1.5 py-2.5 text-center" id="readiness-status-${pr.id}">
                    <span class="text-xs text-slate-400 dark:text-slate-500">-</span>
                </td>
                <td class="px-1.5 py-2.5 text-center" id="readiness-score-${pr.id}">
                    <span class="text-xs text-slate-400 dark:text-slate-500">-</span>
                </td>
                <td class="px-1.5 py-2.5 text-xs text-slate-600 dark:text-slate-400 truncate">${escapeHtml(timeAgo(pr.last_updated_at))}</td>
                <td class="px-1.5 py-2.5 text-center">
                    <div class="flex items-center justify-center gap-1">
                        <button class="update-btn rounded border border-[#E10000] bg-white px-1.5 py-1 text-xs font-semibold text-[#E10000] hover:bg-[#fff1f1] dark:border-red-700 dark:bg-slate-700 dark:text-red-400 dark:hover:bg-red-950/30" data-pr-id="${pr.id}" title="Update PR data and analyze readiness">
                            <i class="fas fa-sync mr-1"></i>Update
                        </button>
                        <button class="view-raw-btn rounded border border-slate-300 bg-white px-1.5 py-1 text-xs font-semibold text-slate-600 hover:bg-slate-50 dark:border-slate-600 dark:bg-slate-700 dark:text-slate-300 dark:hover:bg-slate-600" data-pr-id="${pr.id}" title="View raw PR data">
                            <i class="fas fa-database"></i>
                        </button>
                    </div>
                </td>
            `;

            row.addEventListener('click', (e) => {
                if (e.target.closest('button') || e.target.closest('a')) return;
                openDetailPanel(pr);
            });

            if (activePrId === pr.id) {
                row.classList.add('pr-row-active');
            }

            return row;
        }

        function updateSinglePrRow(prId, prData) {
            const listScrollContainer = getPrListScrollElement();
            const previousMainScrollTop = listScrollContainer ? listScrollContainer.scrollTop : 0;
            const numericPrId = Number(prId);
            // Find and update the PR in allPrs array
            const prIndex = allPrs.findIndex(pr => pr.id === numericPrId);
            if (prIndex !== -1) {
                // Preserve the id from the existing PR
                allPrs[prIndex] = { ...prData, id: numericPrId };
            }

            // Get the existing row
            const existingRow = document.getElementById(`pr-row-${prId}`);
            if (!existingRow) return;

            // Create new row with updated data
            const newRow = createPrRow({ ...prData, id: numericPrId });

            // Replace the old row with the new one
            existingRow.replaceWith(newRow);

            // Re-attach the click event listener to the new button
            const updateBtn = newRow.querySelector('.update-btn');
            if (updateBtn) {
                updateBtn.addEventListener('click', async (e) => {
                    await updatePr(numericPrId, e.currentTarget);
                });
            }

            // Re-attach the click event listener to the view raw button
            const viewRawBtn = newRow.querySelector('.view-raw-btn');
            if (viewRawBtn) {
                viewRawBtn.addEventListener('click', (e) => {
                    showRawDataModal(numericPrId);
                });
            }

            if (detailPrId === numericPrId) {
                renderDetailPanelBody(numericPrId);
            }

            if (listScrollContainer) {
                listScrollContainer.scrollTop = previousMainScrollTop;
            }
        }

        function openDetailPanel(pr) {
            if (activePrId && activePrId !== pr.id) {
                const oldRow = document.getElementById(`pr-row-${activePrId}`);
                if (oldRow) oldRow.classList.remove('pr-row-active');
            }

            detailPrId = pr.id;
            activePrId = pr.id;

            const selectedRow = document.getElementById(`pr-row-${pr.id}`);
            if (selectedRow) selectedRow.classList.add('pr-row-active');

            const titleEl = document.getElementById('panelPrTitle');
            const linkEl = document.getElementById('panelPrLink');
            if (titleEl) titleEl.textContent = pr.title || 'PR Detail';
            if (linkEl) {
                linkEl.href = pr.pr_url || '#';
                linkEl.textContent = pr.pr_url || '';
            }

            renderDetailPanelBody(pr.id);
        }

        function closeDetailPanel() {
            if (detailPrId) {
                const row = document.getElementById(`pr-row-${detailPrId}`);
                if (row) row.classList.remove('pr-row-active');
            }
            const titleEl = document.getElementById('panelPrTitle');
            const linkEl = document.getElementById('panelPrLink');
            if (titleEl) titleEl.textContent = 'Select a PR';
            if (linkEl) {
                linkEl.href = '#';
                linkEl.textContent = '';
            }
            renderPanelPlaceholder('Select a PR row to view detailed stats and refresh history.');
            detailPrId = null;
            activePrId = null;
        }

        function renderDetailPanelBody(prId) {
            const body = document.getElementById('panelBody');
            if (!body) return;

            const pr = allPrs.find(item => item.id === prId);
            let readiness = null;
            let reviewHealth = null;

            if (pr && pr.overall_score !== null && pr.overall_score !== undefined) {
                try {
                    readiness = {
                        overall_score: pr.overall_score,
                        ci_score: pr.ci_score,
                        review_score: pr.review_score,
                        merge_ready: pr.merge_ready === 1,
                        blockers: pr.blockers ? JSON.parse(pr.blockers) : [],
                        warnings: pr.warnings ? JSON.parse(pr.warnings) : [],
                        recommendations: pr.recommendations ? JSON.parse(pr.recommendations) : []
                    };
                    reviewHealth = {
                        response_rate_display: `${Math.round((pr.response_rate || 0) * 100)}%`,
                        stale_feedback: pr.stale_feedback ? JSON.parse(pr.stale_feedback) : []
                    };
                } catch (e) {
                    console.error('Error parsing panel data:', e);
                }
            }

            if (!readiness) {
                const stored = loadReadinessData(prId);
                if (stored) {
                    readiness = stored.readiness;
                    reviewHealth = stored.reviewHealth;
                }
            }

            const history = prRefreshHistory[String(prId)] || [];
            const historyHtml = history.length
                ? `<div class="mt-4">
                    <div class="mb-1 text-[10px] font-semibold uppercase tracking-wider text-slate-500 dark:text-slate-400">Refresh History</div>
                    <div class="space-y-1">${history.slice(-12).reverse().map(entry => `
                        <div class="flex items-start gap-2 text-[11px]">
                            <div class="history-dot ${entry.delta > 0 ? 'bg-emerald-400' : entry.delta < 0 ? 'bg-red-400' : 'bg-slate-300 dark:bg-slate-600'}"></div>
                            <div>
                                <span class="text-slate-500 dark:text-slate-400">${entry.ts}</span>
                                ${entry.delta === null ? '' : `<span class="ml-1 font-semibold ${entry.delta > 0 ? 'text-emerald-600 dark:text-emerald-400' : entry.delta < 0 ? 'text-red-600 dark:text-red-400' : 'text-slate-500 dark:text-slate-400'}">${entry.delta > 0 ? '+' : ''}${entry.delta}%</span>`}
                            </div>
                        </div>`).join('')}
                    </div>
                </div>`
                : '';

            if (!readiness) {
                body.innerHTML = `
                    <div class="space-y-3">
                        <p class="text-xs italic text-slate-500 dark:text-slate-400">Click Refresh to load readiness details.</p>
                        <button id="panelRefreshBtn"
                            class="inline-flex items-center gap-1.5 rounded border border-[#E10000] bg-white px-2.5 py-1.5 text-xs font-semibold text-[#E10000] hover:bg-[#fff1f1] dark:border-red-700 dark:bg-slate-700 dark:text-red-400 dark:hover:bg-red-950/30">
                            <i class="fas fa-sync"></i>
                            <span>Refresh Analysis</span>
                        </button>
                    </div>
                    ${historyHtml}
                `;
                const panelRefreshBtn = document.getElementById('panelRefreshBtn');
                if (panelRefreshBtn) {
                    panelRefreshBtn.addEventListener('click', async () => {
                        await updatePr(prId, panelRefreshBtn);
                    });
                }
                return;
            }

            const itemsToHtml = (items, title, cls) => {
                if (!items || !items.length) return '';
                return `<div class="mb-2">
                    <div class="mb-1 text-[10px] font-semibold uppercase tracking-wider ${cls}">${title} (${items.length})</div>
                    <div class="space-y-1">${items.slice(0, 6).map(item => `<div class="text-[11px] text-slate-700 dark:text-slate-300">${escapeHtml(item.message || String(item))}</div>`).join('')}</div>
                </div>`;
            };

            const normalizeScore = (value) => {
                if (typeof value === 'number' && Number.isFinite(value)) return Math.max(0, Math.min(100, Math.round(value)));
                if (typeof value === 'string') {
                    const parsed = parseFloat(value.replace('%', '').trim());
                    if (Number.isFinite(parsed)) return Math.max(0, Math.min(100, Math.round(parsed)));
                }
                return null;
            };

            const getMeterColor = (score) => {
                if (score === null) return 'bg-slate-300 dark:bg-slate-600';
                if (score >= 70) return 'bg-emerald-500';
                if (score >= 60) return 'bg-amber-500';
                if (score >= 40) return 'bg-orange-500';
                return 'bg-red-500';
            };

            const meterRow = (label, score) => {
                const safeScore = score === null ? 0 : score;
                return `<div>
                    <div class="mb-1 flex items-center justify-between text-[11px]">
                        <span class="font-medium text-slate-600 dark:text-slate-300">${label}</span>
                        <span class="font-semibold text-slate-800 dark:text-slate-100">${score === null ? '-' : `${score}%`}</span>
                    </div>
                    <div class="h-2 overflow-hidden rounded-full bg-slate-200 dark:bg-slate-700">
                        <div class="h-full rounded-full ${getMeterColor(score)} transition-all duration-300" style="width:${safeScore}%"></div>
                    </div>
                </div>`;
            };

            const metricScores = [
                { label: 'Overall', score: normalizeScore(readiness.overall_score) },
                { label: 'CI', score: normalizeScore(readiness.ci_score) },
                { label: 'Review', score: normalizeScore(readiness.review_score) },
                { label: 'Response', score: normalizeScore(reviewHealth?.response_rate_display) }
            ];

            const metersHtml = `<div class="mb-3 rounded border border-slate-200 bg-slate-50 p-2 dark:border-slate-700 dark:bg-slate-800">
                <div class="mb-2 text-[10px] font-semibold uppercase tracking-wider text-slate-500 dark:text-slate-400">Readiness Meters</div>
                <div class="space-y-2">${metricScores.map(metric => meterRow(metric.label, metric.score)).join('')}</div>
            </div>`;

            const trendPoints = history
                .filter(entry => typeof entry.score === 'number' && Number.isFinite(entry.score))
                .slice(-12)
                .map(entry => ({
                    ts: entry.ts,
                    score: normalizeScore(entry.score)
                }))
                .filter(entry => entry.score !== null);
            const currentOverallScore = normalizeScore(readiness.overall_score);
            if (currentOverallScore !== null && (!trendPoints.length || trendPoints[trendPoints.length - 1].score !== currentOverallScore)) {
                trendPoints.push({ ts: 'Now', score: currentOverallScore });
            }

            let trendHtml = '';
            if (trendPoints.length >= 2) {
                const width = 280;
                const height = 92;
                const pad = 10;
                const points = trendPoints.map((point, index) => {
                    const x = pad + ((width - (pad * 2)) * index / (trendPoints.length - 1));
                    const y = height - pad - ((height - (pad * 2)) * (point.score / 100));
                    return { x, y, ts: point.ts, score: point.score };
                });
                const polyline = points.map(point => `${point.x},${point.y}`).join(' ');
                const circles = points.map(point => `<circle cx="${point.x}" cy="${point.y}" r="2.5" fill="#e11d48"><title>${escapeHtml(`${point.ts}: ${point.score}%`)}</title></circle>`).join('');
                trendHtml = `<div class="mb-3 rounded border border-slate-200 bg-slate-50 p-2 dark:border-slate-700 dark:bg-slate-800">
                    <div class="mb-2 flex items-center justify-between text-[10px] font-semibold uppercase tracking-wider text-slate-500 dark:text-slate-400">
                        <span>Score Trend</span>
                        <span class="normal-case tracking-normal">${trendPoints[trendPoints.length - 1].score}% now</span>
                    </div>
                    <svg viewBox="0 0 ${width} ${height}" class="w-full h-24">
                        <line x1="${pad}" y1="${height - pad}" x2="${width - pad}" y2="${height - pad}" stroke="currentColor" class="text-slate-300 dark:text-slate-600" />
                        <line x1="${pad}" y1="${pad}" x2="${pad}" y2="${height - pad}" stroke="currentColor" class="text-slate-300 dark:text-slate-600" />
                        <polyline points="${polyline}" fill="none" stroke="#e11d48" stroke-width="2" />
                        ${circles}
                    </svg>
                </div>`;
            }

            body.innerHTML = `
                <div class="mb-3 grid grid-cols-2 gap-2 text-xs">
                    <div class="rounded border border-slate-200 bg-slate-50 p-2 dark:border-slate-700 dark:bg-slate-800"><span class="text-slate-500 dark:text-slate-400">Overall</span><div class="text-sm font-bold text-slate-900 dark:text-slate-100">${readiness.overall_score ?? '-'}%</div></div>
                    <div class="rounded border border-slate-200 bg-slate-50 p-2 dark:border-slate-700 dark:bg-slate-800"><span class="text-slate-500 dark:text-slate-400">Merge Ready</span><div class="text-sm font-bold text-slate-900 dark:text-slate-100">${readiness.merge_ready ? 'Yes' : 'No'}</div></div>
                    <div class="rounded border border-slate-200 bg-slate-50 p-2 dark:border-slate-700 dark:bg-slate-800"><span class="text-slate-500 dark:text-slate-400">CI Score</span><div class="text-sm font-bold text-slate-900 dark:text-slate-100">${readiness.ci_score ?? '-'}%</div></div>
                    <div class="rounded border border-slate-200 bg-slate-50 p-2 dark:border-slate-700 dark:bg-slate-800"><span class="text-slate-500 dark:text-slate-400">Response</span><div class="text-sm font-bold text-slate-900 dark:text-slate-100">${reviewHealth?.response_rate_display || '-'}</div></div>
                </div>
                ${metersHtml}
                ${trendHtml}
                ${itemsToHtml(readiness.blockers, 'Blockers', 'text-red-600 dark:text-red-400')}
                ${itemsToHtml(readiness.warnings, 'Warnings', 'text-amber-600 dark:text-amber-400')}
                ${itemsToHtml(readiness.recommendations, 'Recommendations', 'text-blue-600 dark:text-blue-400')}
                ${reviewHealth?.stale_feedback?.length ? itemsToHtml(reviewHealth.stale_feedback, 'Stale Feedback', 'text-slate-500 dark:text-slate-400') : ''}
                ${historyHtml}
            `;
        }

        async function updatePr(prId, button) {
            const originalHtml = button.innerHTML;
            const numericPrId = Number(prId);
            const isPanelButton = button.id === 'panelRefreshBtn';
            const existing = allPrs.find(item => item.id === numericPrId);
            const previousScore = existing && typeof existing.ready_score === 'number'
                ? existing.ready_score
                : (existing && typeof existing.overall_score === 'number' ? existing.overall_score : null);

            button.disabled = true;
            // Keep table button compact to avoid text overflow in narrow cells.
            button.innerHTML = isPanelButton
                ? '<i class="fas fa-spinner fa-spin mr-1"></i>Refreshing...'
                : '<i class="fas fa-spinner fa-spin"></i>';
            button.classList.add('opacity-70', 'cursor-not-allowed');

            try {
                // Step 1: Refresh PR data from GitHub
                const refreshResponse = await fetch('/api/refresh', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ pr_id: prId })
                });

                const refreshData = await refreshResponse.json();
                if (refreshData.error) {
                    showInlineError(`pr-row-${prId}`, refreshData.error);
                    return;
                }

                // Clear cached readiness data for this PR since it's being refreshed
                clearReadinessData(prId);
                invalidateApiCache();

                // Check if PR was removed due to being merged/closed
                if (refreshData.removed) {
                    // Remove PR from allPrs array
                    const prIndex = allPrs.findIndex(pr => pr.id === numericPrId);
                    if (prIndex !== -1) {
                        allPrs.splice(prIndex, 1);
                    }

                    // Get the row element
                    const row = document.getElementById(`pr-row-${prId}`);
                    if (row) {
                        // Add fade-out animation
                        row.style.transition = 'opacity 0.3s ease-out, transform 0.3s ease-out';
                        row.style.opacity = '0';
                        row.style.transform = 'translateX(20px)';

                        // Remove the row after animation completes
                        setTimeout(async () => {
                            row.remove();

                            // Update repos list (counts might have changed)
                            await loadRepos();

                            // Check if there are no PRs left
                            if (allPrs.length === 0) {
                                const container = document.getElementById('prListContainer');
                                if (container) {
                                    container.innerHTML = '<div class="rounded-xl border border-dashed border-slate-300 bg-white p-10 text-center dark:border-slate-600 dark:bg-slate-800"><h3 class="text-xl font-semibold text-slate-900 dark:text-slate-100">No PRs Added Yet</h3><p class="mt-2 text-sm text-slate-500 dark:text-slate-400">Add a GitHub PR URL above to start tracking</p></div>';
                                }
                            }
                        }, 300);
                    }

                    if (detailPrId === numericPrId) {
                        closeDetailPanel();
                    }

                    // Show success message
                    showError(refreshData.message || 'PR has been closed and removed from tracking');
                    await loadRateLimit();
                    return;
                }

                // Update only this PR row with fresh data
                updateSinglePrRow(prId, refreshData.data);
                await loadRateLimit();

                // Get the new button reference after row update
                const updatedRow = document.getElementById(`pr-row-${prId}`);
                const updatedButton = updatedRow ? updatedRow.querySelector('.update-btn') : null;

                // Step 2: Analyze readiness
                const readinessResponse = await fetch(`/api/prs/${prId}/readiness`);
                const readinessData = await readinessResponse.json();

                if (readinessData.error) {
                    showInlineError(`pr-row-${prId}`, readinessData.error);
                    return;
                }

                const readiness = readinessData.readiness;
                const reviewHealth = readinessData.review_health;

                // Save readiness data to localStorage
                saveReadinessData(prId, readiness, reviewHealth);
                addRefreshHistoryEntry(prId, previousScore, readiness.overall_score);

                // Update all inline cells with readiness data
                updateInlineCells(prId, readiness, reviewHealth);
                if (detailPrId === numericPrId) {
                    renderDetailPanelBody(numericPrId);
                }

                if (updatedButton) {
                    updatedButton.innerHTML = '<i class="fas fa-check mr-1"></i>Updated';
                    updatedButton.disabled = false;
                    updatedButton.classList.remove('opacity-70', 'cursor-not-allowed');
                }
            } catch (error) {
                console.error('Error updating PR:', error);
                showInlineError(`pr-row-${prId}`, 'Failed to update PR');
                if (isPanelButton) {
                    showError('Failed to refresh analysis');
                }
            } finally {
                if (button && button.isConnected) {
                    button.disabled = false;
                    button.classList.remove('opacity-70', 'cursor-not-allowed');
                    button.innerHTML = originalHtml;
                }
            }
        }

        function updateInlineCells(prId, readiness, reviewHealth) {
            // Score color classes helper
            const getScoreColor = (score) => {
                if (score >= 70) return 'text-emerald-700 dark:text-emerald-400';
                if (score >= 60) return 'text-amber-600 dark:text-amber-400';
                if (score >= 40) return 'text-orange-600 dark:text-orange-400';
                return 'text-red-600 dark:text-red-400';
            };

            // Update Merge Ready Status
            const statusCell = document.getElementById(`readiness-status-${prId}`);
            if (statusCell) {
                const icon = readiness.merge_ready ? '' : '';
                statusCell.innerHTML = `<span class="text-base">${icon}</span>`;
            }

            // Update Ready Score
            const scoreCell = document.getElementById(`readiness-score-${prId}`);
            if (scoreCell) {
                const scoreClass = getScoreColor(readiness.overall_score);
                scoreCell.innerHTML = `<span class="${scoreClass} text-xs font-bold">${readiness.overall_score_display}</span>`;
            }

            // Update CI score
            const ciCell = document.getElementById(`readiness-ci-${prId}`);
            if (ciCell) {
                const scoreClass = getScoreColor(readiness.ci_score);
                ciCell.innerHTML = `<span class="${scoreClass} text-xs font-bold">${readiness.ci_score_display}</span>`;
            }

            // Update Review score
            const reviewCell = document.getElementById(`readiness-review-${prId}`);
            if (reviewCell) {
                const scoreClass = getScoreColor(readiness.review_score);
                reviewCell.innerHTML = `<span class="${scoreClass} text-xs font-bold">${readiness.review_score_display}</span>`;
            }

            // Update Response rate
            const responseCell = document.getElementById(`readiness-response-${prId}`);
            if (responseCell) {
                const responseScore = parseFloat(reviewHealth.response_rate_display.replace('%', ''));
                const scoreClass = getScoreColor(responseScore);
                responseCell.innerHTML = `<span class="${scoreClass} text-xs font-bold">${reviewHealth.response_rate_display}</span>`;
            }

            // Update Feedback
            const feedbackCell = document.getElementById(`readiness-feedback-${prId}`);
            if (feedbackCell) {
                const feedbackPercent = reviewHealth.total_feedback > 0 ?
                    (reviewHealth.responded_feedback / reviewHealth.total_feedback) * 100 : 100;
                const scoreClass = getScoreColor(feedbackPercent);
                feedbackCell.innerHTML = `<span class="${scoreClass} text-xs font-bold">${reviewHealth.responded_feedback}/${reviewHealth.total_feedback}</span>`;
            }

            // Update Issues/Blockers column
            const issuesCell = document.getElementById(`readiness-issues-${prId}`);
            if (issuesCell) {
                let issuesHTML = '<div class="text-xs space-y-0.5">';
                let hasIssues = false;

                // Show blockers
                if (readiness.blockers && readiness.blockers.length > 0) {
                    hasIssues = true;
                    issuesHTML += `<div class="flex items-start gap-1 text-red-700 dark:text-red-400">`;
                    issuesHTML += `<span class="font-bold"></span>`;
                    issuesHTML += `<span class="truncate" title="${escapeHtml(readiness.blockers.join('; '))}">${escapeHtml(readiness.blockers[0])}</span>`;
                    if (readiness.blockers.length > 1) {
                        issuesHTML += `<span class="font-semibold">+${readiness.blockers.length - 1}</span>`;
                    }
                    issuesHTML += `</div>`;
                }

                // Show warnings
                if (readiness.warnings && readiness.warnings.length > 0) {
                    hasIssues = true;
                    issuesHTML += `<div class="flex items-start gap-1 text-amber-700 dark:text-amber-400">`;
                    issuesHTML += `<span class="font-bold"></span>`;
                    issuesHTML += `<span class="truncate" title="${escapeHtml(readiness.warnings.join('; '))}">${escapeHtml(readiness.warnings[0])}</span>`;
                    if (readiness.warnings.length > 1) {
                        issuesHTML += `<span class="font-semibold">+${readiness.warnings.length - 1}</span>`;
                    }
                    issuesHTML += `</div>`;
                }

                // Show recommendations
                if (readiness.recommendations && readiness.recommendations.length > 0) {
                    hasIssues = true;
                    issuesHTML += `<div class="flex items-start gap-1 text-blue-700 dark:text-blue-400">`;
                    issuesHTML += `<span class="font-bold"></span>`;
                    issuesHTML += `<span class="truncate" title="${escapeHtml(readiness.recommendations.join('; '))}">${escapeHtml(readiness.recommendations[0])}</span>`;
                    if (readiness.recommendations.length > 1) {
                        issuesHTML += `<span class="font-semibold">+${readiness.recommendations.length - 1}</span>`;
                    }
                    issuesHTML += `</div>`;
                }

                if (!hasIssues) {
                    issuesHTML += '<span class="text-emerald-600 dark:text-emerald-400 font-semibold"> All Clear</span>';
                }

                issuesHTML += '</div>';
                issuesCell.innerHTML = issuesHTML;
            }
        }

        function invalidateApiCache(path) {
            if (navigator.serviceWorker && navigator.serviceWorker.controller) {
                navigator.serviceWorker.controller.postMessage({
                    type: 'INVALIDATE_API_CACHE',
                    path: path || '/api/'
                });
            }
        }

        async function addPr() {
            const input = document.getElementById('prUrlInput');
            const btn = document.getElementById('addPrBtn');
            const checkbox = document.getElementById('addAllPrsCheckbox');
            const prUrl = input.value.trim();
            const addAll = checkbox.checked;

            if (!prUrl) {
                showInputError('prUrlInput', 'Please enter a PR URL');
                return;
            }

            btn.disabled = true;
            btn.textContent = addAll ? 'Importing...' : 'Adding...';

            try {
                // If importing all, handle logic to send repo_url appropriately
                // But preserving your existing logic structure:
                const response = await fetch('/api/prs', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        pr_url: prUrl,
                        add_all: addAll
                    })
                });

                const data = await response.json();
                if (data.error) {
                    showInputError('prUrlInput', data.error);
                } else {
                    input.value = '';
                    invalidateApiCache();
                    await loadRepos();
                    await loadPrs();
                    await loadRateLimit();
                }
            } catch (error) {
                console.error('Error adding PR:', error);
                showInputError('prUrlInput', 'Failed to add PR');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Add PR';
            }
        }

        async function addAllPrsFromRepo(repoOwner, repoName, buttonElement) {
            // Show loading state
            const originalHTML = buttonElement.innerHTML;
            buttonElement.disabled = true;
            buttonElement.innerHTML = '<i class="fas fa-spinner fa-spin text-xl text-red-600"></i>';

            try {
                const repoUrl = `https://github.com/${repoOwner}/${repoName}`;
                const response = await fetch('/api/prs', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        pr_url: repoUrl,
                        add_all: true
                    })
                });

                const data = await response.json();
                if (data.error) {
                    alert(`Failed to import PRs: ${data.error}`);
                } else {
                    // Show success message, with truncation warning if applicable
                    if (data.truncated) {
                        alert(` Import Completed with Limit\n\n${data.message}\n\nNote: This repository has more open PRs than can be imported at once. You can manually add additional PRs using the "Add PR" form.`);
                    } else {
                        alert(` Import completed successfully.\n\n${data.message || 'All open PRs were imported successfully.'}`);
                    }
                    invalidateApiCache();
                    await loadRepos();
                    await loadPrs();
                    await loadRateLimit();
                }
            } catch (error) {
                console.error('Error importing PRs:', error);
                alert(`Failed to import PRs from ${repoOwner}/${repoName}`);
            } finally {
                buttonElement.disabled = false;
                buttonElement.innerHTML = originalHTML;
            }
        }

        // Search listener
        document.getElementById('prSearchInput').addEventListener('input', (e) => {
            currentPage = 1;
            filterPrs(e.target.value);
        });

        // Search button listener
        document.getElementById('searchBtn').addEventListener('click', () => {
            const searchTerm = document.getElementById('prSearchInput').value;
            filterPrs(searchTerm);
        });

        // Clear button listener
        document.getElementById('clearSearchBtn').addEventListener('click', () => {
            document.getElementById('prSearchInput').value = '';
            filterPrs('');
        });

        // Allow Enter key to trigger search
        document.getElementById('prSearchInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                const searchTerm = document.getElementById('prSearchInput').value;
                filterPrs(searchTerm);
            }
        });

        document.getElementById('addPrBtn').addEventListener('click', addPr);
        document.getElementById('prUrlInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') addPr();
        });

        document.querySelector('[data-repo="all"]').addEventListener('click', () => {
            currentRepo = 'all';
            currentPage = 1;
            localStorage.setItem('currentRepo', currentRepo);
            document.querySelectorAll('.repo-item').forEach(item => {
                setRepoItemActiveState(item, item.dataset.repo === currentRepo);
            });
            if (isMobileSidebarViewport()) closeSidebar();
            loadPrs();
        });

        // Delegated event listener for plus buttons (import all PRs)
        document.getElementById('repoList').addEventListener('click', async (e) => {
            const btn = e.target.closest('.add-all-prs-btn');
            if (btn) {
                e.stopPropagation();
                const repoOwner = btn.dataset.repoOwner;
                const repoName = btn.dataset.repoName;
                await addAllPrsFromRepo(repoOwner, repoName, btn);
            }
        });

        // Theme toggle functionality
        function initTheme() {
            // Theme class is already set in the head, just update the icon
            const isDark = document.documentElement.classList.contains('dark');
            const themeIcon = document.getElementById('themeIcon');

            if (isDark) {
                themeIcon.className = 'fas fa-sun';
            } else {
                themeIcon.className = 'fas fa-moon';
            }
        }

        function toggleTheme() {
            const isDark = document.documentElement.classList.contains('dark');
            const themeIcon = document.getElementById('themeIcon');

            if (isDark) {
                document.documentElement.classList.remove('dark');
                themeIcon.className = 'fas fa-moon';
                localStorage.setItem('theme', 'light');
            } else {
                document.documentElement.classList.add('dark');
                themeIcon.className = 'fas fa-sun';
                localStorage.setItem('theme', 'dark');
            }
        }

        document.getElementById('themeToggle').addEventListener('click', toggleTheme);
        document.getElementById('autoRefreshToggle').addEventListener('click', toggleAutoRefresh);
        document.getElementById('sidebarToggleBtn')?.addEventListener('click', toggleSidebar);
        document.getElementById('sidebarBackdrop')?.addEventListener('click', () => closeSidebar(true));
        document.getElementById('mainColumn')?.addEventListener('click', () => {
            if (isMobileSidebarViewport() && document.body.classList.contains('sidebar-open')) {
                closeSidebar(false);
            }
        });

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && document.body.classList.contains('sidebar-open')) {
                closeSidebar(true);
            }
        });

        // Make sortPrs globally accessible for onclick handlers
        window.sortPrs = sortPrs;

        // Set up event delegation for sorting (one-time setup)
        // This persists across table re-renders since prListContainer is stable
        const prListContainer = document.getElementById('prListContainer');
        prListContainer.addEventListener('click', (e) => {
            const filterChip = e.target.closest('.filter-chip[data-filter-type]');
            if (filterChip) {
                const filterType = filterChip.dataset.filterType;
                const filterValue = filterChip.dataset.filterValue;
                if (filterType === 'state') {
                    activeStateFilter = filterValue;
                } else if (filterType === 'review') {
                    activeReviewFilter = filterValue;
                }
                applyClientFilters();
                return;
            }

            // Handle sortable table header clicks
            const th = e.target.closest('th[data-sort-column]');
            if (th) {
                const column = th.getAttribute('data-sort-column');
                const isShiftClick = e.shiftKey;
                sortPrs(column, isShiftClick);
                return;
            }

            // Handle Clear Sort button
            if (e.target.closest('#clearSortBtn')) {
                sortColumns = [{ column: 'ready_score', direction: 'desc' }];
                localStorage.setItem('sortColumns', JSON.stringify(sortColumns));
                currentPage = 1;
                loadPrs();
                return;
            }

            // Handle Sort by Readiness button
            if (e.target.closest('#sortByReadinessBtn')) {
                sortColumns = [{ column: 'ready_score', direction: 'desc' }];
                localStorage.setItem('sortColumns', JSON.stringify(sortColumns));
                currentPage = 1;
                loadPrs();
                return;
            }
        });

        document.getElementById('closePanelBtn')?.addEventListener('click', closeDetailPanel);
        
        // Raw Data Modal event listeners
        document.getElementById('closeRawDataModal')?.addEventListener('click', () => {
            document.getElementById('rawDataModal').classList.add('hidden');
        });
        document.getElementById('closeRawDataModalBtn')?.addEventListener('click', () => {
            document.getElementById('rawDataModal').classList.add('hidden');
        });
        document.getElementById('copyRawDataBtn')?.addEventListener('click', () => {
            const content = document.getElementById('rawDataContent').textContent;
            navigator.clipboard.writeText(content).then(() => {
                const btn = document.getElementById('copyRawDataBtn');
                const originalHtml = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-check mr-1"></i>Copied!';
                setTimeout(() => {
                    btn.innerHTML = originalHtml;
                }, 2000);
            });
        });
        
        // Show raw data modal function
        function showRawDataModal(prId) {
            const pr = allPrs.find(item => item.id === Number(prId));
            if (!pr) return;
            
            const modal = document.getElementById('rawDataModal');
            const content = document.getElementById('rawDataContent').querySelector('code');

            const safeJsonParse = (value, fallback = []) => {
                if (!value) return fallback;
                if (Array.isArray(value) || typeof value === 'object') return value;
                try {
                    return JSON.parse(value);
                } catch (err) {
                    return fallback;
                }
            };
            
            // Format PR data for display
            const displayData = {
                id: pr.id,
                pr_number: pr.pr_number,
                pr_url: pr.pr_url,
                title: pr.title,
                state: pr.state,
                is_draft: pr.is_draft,
                author: {
                    login: pr.author_login,
                    avatar: pr.author_avatar,
                    url: pr.author_url
                },
                repository: {
                    owner: pr.repo_owner,
                    name: pr.repo_name,
                    full_name: `${pr.repo_owner}/${pr.repo_name}`
                },
                review_status: pr.review_status,
                reviewers: safeJsonParse(pr.reviewers, []),
                checks: {
                    passed: pr.checks_passed,
                    failed: pr.checks_failed
                },
                conversations: {
                    open: pr.open_conversations_count
                },
                readiness: pr.overall_score !== null ? {
                    overall_score: pr.overall_score,
                    ci_score: pr.ci_score,
                    review_score: pr.review_score,
                    merge_ready: pr.merge_ready === 1,
                    blockers: safeJsonParse(pr.blockers, []),
                    warnings: safeJsonParse(pr.warnings, []),
                    recommendations: safeJsonParse(pr.recommendations, []),
                    response_rate: pr.response_rate,
                    stale_feedback: safeJsonParse(pr.stale_feedback, [])
                } : null,
                timestamps: {
                    created_at: pr.created_at,
                    last_updated_at: pr.last_updated_at,
                    last_refreshed_at: pr.last_refreshed_at
                }
            };
            
            content.textContent = JSON.stringify(displayData, null, 2);
            modal.classList.remove('hidden');
        }
        
        window.addEventListener('resize', () => {
            updatePanelTopOffset();
            updateSidebarTopOffset();
            updateMainContentHeight();
            adjustPrTableHeight();
            syncSidebarWithViewport();
        });

        initTheme();
        updatePanelTopOffset();
        updateSidebarTopOffset();
        updateMainContentHeight();
        adjustPrTableHeight();
        syncSidebarWithViewport();
        loadRateLimit();
        loadLatestRelease();
        loadRepos();
        loadPrs();
        setInterval(loadRateLimit, 600000);

        // Initialize auto-refresh
        updateAutoRefreshUI();
        if (autoRefreshEnabled) {
            startAutoRefresh();
        }

        // Service Worker Registration
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js')
                .then(reg => console.log('SW Registered:', reg.scope))
                .catch(err => console.warn('SW Registration failed:', err));
        }
    </script>
</body>

</html>
